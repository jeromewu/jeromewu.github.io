{"componentChunkName":"component---src-templates-blog-post-js","path":"/build-ffmpeg-webassembly-version-part-1-preparation/","result":{"data":{"site":{"siteMetadata":{"title":"TechBlog"}},"markdownRemark":{"id":"cbbbe569-df81-50fb-909f-268110d0040c","excerpt":"In this part you will learn: The background of this series How to build native FFmpeg with Docker (and without docker in MacOS) The background of this series‚Ä¶","html":"<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 630px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/899a0ba50105cb44cf23fe8cc40b8e42/6af66/ffmpeg-wasm-cover.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 56.32911392405063%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAALCAIAAADwazoUAAAACXBIWXMAAAsTAAALEwEAmpwYAAABa0lEQVQoz52RsUrDUBSG+zCugg8guPoKQl9BAtVC0UWq7eTUJUhpohVzSzIkNIPQpTZDRUpxspChg0OTqEmT3phAenPvFZuaBlsc/MYD3zk//8nRH6I4uuryO9Xdk/uzvtYvn5fb7bZlWY7jQAh933ddNwgCmiFHKSWUUEqDebBX29+62D5Uj0VBLBwV+Gu+VCoxDFMsFvP5PMMwAABKaRzHG+TbocA+1i97NWc6tW3b8zzTNHsLDMMAAHQ6HUopxngl/5uVTChGcYQwwgQnu4MgkGU5DEOcYbO82kK+bUJIFEW6riOEkqhkQdbPpYI9G1nTJxhOljky+J9+HMeJvOEyQmgwPtX0g/GbNByMGo06z/OKokiSpKoqAIBl2QbHSZLEc1zyMJLKczQ3nJeJ/fzhvXYftJtm804QQKslSmJP02RZrlQrsqIIiyH0/STsUsYEO65tvZvQn623EIYhhPCvttcLS0v6NUzlL8i3UGQPK6VDAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"ffmpeg wasm cover\"\n        title=\"ffmpeg wasm cover\"\n        src=\"/static/899a0ba50105cb44cf23fe8cc40b8e42/f058b/ffmpeg-wasm-cover.png\"\n        srcset=\"/static/899a0ba50105cb44cf23fe8cc40b8e42/c26ae/ffmpeg-wasm-cover.png 158w,\n/static/899a0ba50105cb44cf23fe8cc40b8e42/6bdcf/ffmpeg-wasm-cover.png 315w,\n/static/899a0ba50105cb44cf23fe8cc40b8e42/f058b/ffmpeg-wasm-cover.png 630w,\n/static/899a0ba50105cb44cf23fe8cc40b8e42/6af66/ffmpeg-wasm-cover.png 640w\"\n        sizes=\"(max-width: 630px) 100vw, 630px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span></p>\n<p>In this part you will learn:</p>\n<ol>\n<li>The background of this series</li>\n<li>How to build native FFmpeg with Docker (and without docker in MacOS)</li>\n</ol>\n<hr>\n<h2>The background of this series</h2>\n<p>This series of stories aim to serve following purposes:</p>\n<ol>\n<li>A guide for people who want to learn how to use Emscripten to compile a C/C++ library to JavaScript (Hopefully the most useful and detailed so far)</li>\n<li>Personal notes</li>\n</ol>\n<h2>Why FFmpeg?</h2>\n<p>FFmpeg is a free and open-source project consisting of a vast software suite of libraries and programs for handling video, audio, and other multimedia files and streams. (from Wikipedia)</p>\n<p>It is an useful library and there is no JavaScript library with exactly the same capabilities. If you google ‚Äúffmpeg.js‚Äù, you will find few existing libraries exactly the same as what we are going to build:</p>\n<ul>\n<li>ffmpeg.js: <a href=\"https://github.com/Kagami/ffmpeg.js\">https://github.com/Kagami/ffmpeg.js</a></li>\n<li>videoconverter.js: <a href=\"https://github.com/bgrins/videoconverter.js\">https://github.com/bgrins/videoconverter.js</a></li>\n</ul>\n<p>These libraries are great and ready-to-use in most cases, but they are suffering from following issues:</p>\n<ul>\n<li>The versions of both FFmpeg and Emscripten are out-dated.</li>\n<li>Not under active maintenance for years. (Kagami/ffmpeg.js continues its development in April 2020)</li>\n</ul>\n<p>I considered to take over maybe one of the repositories, but as there are too many changes these years, I decided to do it from scratch and wrote this series of tutorial at the same time to help people to learn how to use Emscripten in a real world C/C++ library.</p>\n<h2>How to build native FFmpeg with Docker</h2>\n<p>To start with, we need to clone FFmpeg source code from its repository, as the master branch is under development, it is better we choose a specific release to compile.</p>\n<p>At the moment I wrote the story, the latest stable version of FFmpeg is n4.3.1, so we will use this version through out the stories.</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token comment\"># Use depth=1 to download only the latest version</span>\n<span class=\"token function\">git</span> clone --depth <span class=\"token number\">1</span> --branch n4.3.1 https://github.com/FFmpeg/FFmpeg</code></pre></div>\n<p>After completing cloning the repository, it is time to build with GCC to make sure it works.</p>\n<p>Actually you can skip this part if you are in a rush, but in my own experience it is better to get used to the build system of library first.</p>\n<p>The instruction of building and installing FFmpeg can be found inside <a href=\"https://github.com/FFmpeg/FFmpeg/blob/n4.3.1/INSTALL.md\">INSTALL.md</a> in the root of the repository:</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">Installing FFmpeg:\n1. Type `./configure` to create the configuration. A list of configure options is printed by running `configure -help`.\n`configure` can be launched from a directory different from the FFmpeg sources to build the objects out of tree. To do this, use an absolute path when launching `configure`, e.g. `/ffmpegdir/ffmpeg/configure`.\n2. Then type `make` to build FFmpeg. GNU Make 3.81 or later is required.\n3. Type `make install` to install all binaries and libraries you built.\nNOTICE\n - - -\n- Non system dependencies (e.g. libx264, libvpx) are disabled by default.</code></pre></div>\n<p>As we don‚Äôt need to actually install the FFmpeg, only step 1 and 2 are required.</p>\n<p>There are two ways to build, one is native way which requires you to install packages (ex. emsdk, Node.js). Most of time it works, but sometimes you may face bugs that is hard to resolve due to the variation of package versions and operating system. Another way is to use Docker, which provides a stable and static build environments. It is highly recommended to use Docker as it saves your time to install (and remove) the packages.</p>\n<p>I will not cover how to install the packages here, but as I split the scripts into <code class=\"language-text\">build.sh</code> and <code class=\"language-text\">build-with-docker.sh</code> , you can install all the packages yourself and run <code class=\"language-text\">build.sh</code>.</p>\n<blockquote>\n<p>To make sure this tutorial can achieve maximum coverage of environments, I use Github Actions to test if it works on Linux and MacOS. For Linux users, I will use Docker way / <code class=\"language-text\">build-with-docker.sh</code> to build. For MacOS users, as Docker is not supported in Github Actions, I will use native way / <code class=\"language-text\">build.sh</code> to build.</p>\n</blockquote>\n<p>Now, let‚Äôs create a file called <code class=\"language-text\">build.sh</code> with following content.</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token shebang important\">#!/bin/bash -x</span>\n<span class=\"token comment\"># gcc 8 is used in this tutorial, other versions may fail</span>\n./configure --disable-x86asm\n<span class=\"token function\">make</span> -j</code></pre></div>\n<p>To build in native way, you can simply run command:</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">$ <span class=\"token function\">bash</span> build.sh</code></pre></div>\n<p>To build with Docker, create a file called <code class=\"language-text\">build-with-docker.sh</code> with following content:</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token shebang important\">#!/bin/bash -x</span>\n<span class=\"token function\">docker</span> pull gcc:8\n<span class=\"token function\">docker</span> run <span class=\"token punctuation\">\\</span>\n  -v <span class=\"token environment constant\">$PWD</span>:/usr/src <span class=\"token punctuation\">\\</span>\n  gcc:8 <span class=\"token punctuation\">\\</span>\n  <span class=\"token function\">sh</span> -c <span class=\"token string\">'cd /usr/src &amp;&amp; bash build.sh'</span></code></pre></div>\n<p>And run command:</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">$ <span class=\"token function\">bash</span> build-with-docker.sh</code></pre></div>\n<blockquote>\n<p><code class=\"language-text\">--disable-x86asm</code> is required to disable x86 assemble features as we are not going to use it.</p>\n</blockquote>\n<p>Depend on the speed of you Internet and the hardware specification of your computer, it may take 10~30 minutes to complete the compilation.\nAnd it is normal that you see tons of warnings during compilation as gcc 9 introduces more constrains.</p>\n<p>It should take some time to compile the native FFmpeg. If everything is OK, you should be able to run <code class=\"language-text\">ffmpeg</code> with following command:</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">$ ./ffmpeg</code></pre></div>\n<p>You should see something like:</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">ffmpeg version n4.3.1 Copyright ¬© 2000‚Äì2019 the FFmpeg developers\nbuilt with gcc 8 (GCC)\nconfiguration: ‚Äî disable-x86asm\nlibavutil 56. 22.100 / 56. 22.100\nlibavcodec 58. 35.100 / 58. 35.100\nlibavformat 58. 20.100 / 58. 20.100\nlibavdevice 58. 5.100 / 58. 5.100\nlibavfilter 7. 40.101 / 7. 40.101\nlibswscale 5. 3.100 / 5. 3.100\nlibswresample 3. 3.100 / 3. 3.100\nHyper fast Audio and Video encoder\nusage: ffmpeg [options] [[infile options] -i infile]‚Ä¶ {[outfile options] outfile}‚Ä¶\nUse -h to get full help or, even better, run ‚Äòman ffmpeg‚Äô</code></pre></div>\n<p>You can visit the repository here to see how it works in details: <a href=\"https://github.com/ffmpegwasm/FFmpeg/tree/n4.3.1-p1\">https://github.com/ffmpegwasm/FFmpeg/tree/n4.3.1-p1</a></p>\n<p>And feel free to download the build artifacts here: <a href=\"https://github.com/ffmpegwasm/FFmpeg/releases/tag/n4.3.1-p1\">https://github.com/ffmpegwasm/FFmpeg/releases/tag/n4.3.1-p1</a></p>\n<hr>\n<p>Now we have completed the preparation, let‚Äôs move on to next post to start compiling FFmpeg with Emscripten. üòÉ</p>","frontmatter":{"title":"Build FFmpeg WebAssembly version (= ffmpeg.wasm): Part.1 Preparation","date":"October 13, 2019","description":"A series of tutorials of using Emscripten to build ffmpeg"}},"previous":{"fields":{"slug":"/why-i-refactor-tesseract.js-v2/"},"frontmatter":{"title":"Why I refactor tesseract.js v2?"}},"next":{"fields":{"slug":"/build-ffmpeg-webassembly-version-part-2-compile-with-emscripten/"},"frontmatter":{"title":"Build FFmpeg WebAssembly version (= ffmpeg.wasm): Part.2 Compile with Emscripten"}}},"pageContext":{"id":"cbbbe569-df81-50fb-909f-268110d0040c","previousPostId":"462ec7d2-e380-5680-8df3-e4523e795191","nextPostId":"e7b0e078-202f-52b5-9e84-2a39e2b3441f"}},"staticQueryHashes":["2841359383","3257411868"]}