{"componentChunkName":"component---src-templates-blog-post-js","path":"/build-ffmpeg-webassembly-version-part-3-v0.1/","result":{"data":{"site":{"siteMetadata":{"title":"TechBlog"}},"markdownRemark":{"id":"4372b041-ef89-55ba-96e0-5f919a3b90ff","excerpt":"In this part you will learn: Build a library version of FFmpeg with optimized arguments. Interact with ffmpeg.wasm Manage Emscripten File System. Develop ffmpegâ€¦","html":"<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 630px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/899a0ba50105cb44cf23fe8cc40b8e42/6af66/ffmpeg-wasm-cover.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 56.32911392405063%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAALCAIAAADwazoUAAAACXBIWXMAAAsSAAALEgHS3X78AAABcklEQVQoz4WQUUvCUBiG+zPddRN0223/IxSDhr/AiDJkYxcGIQoiSYK7i8zE8q4N3AJRGzKtG3WDhZZkbrLtbG7rbBOtkflwLs75zvt+7znfhm3blu0AZuD4Ft083Y5UTko3d6GDUDabpWm6Xq9zHFer1ViWFUXR0Vuew95wzc5BBvLuxd4WvrN/fVgu3cfP44VCIRqNIggSDoeDwWAgEEin01BpGMbS7KHNQFNkq32m2C4DHRgusM7zvCAIcAPDW62WP/lPoMI0TQCAvZqfZtOyZqazTK/3dDolCEJV1fm1aS4y1yR74bIsr0+GTXuD4qt4OfxqwKOqKpqmwShd1xVF4QUedplMJpqL36wb+nMfe+oivY9i5YGMxc4wDEumkslUKk/kM5lM5CiC43gikUBRVJIk711zs2HowxH/9t4djQcc1yYpqgqhHTovnUeSvMrlGs0mRVEMw8C3/Ep2vyd9jkeqpqya/P/TXkp9+OoL5TdLEVHIfhB1uAAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"ffmpeg wasm cover\"\n        title=\"ffmpeg wasm cover\"\n        src=\"/static/899a0ba50105cb44cf23fe8cc40b8e42/f058b/ffmpeg-wasm-cover.png\"\n        srcset=\"/static/899a0ba50105cb44cf23fe8cc40b8e42/c26ae/ffmpeg-wasm-cover.png 158w,\n/static/899a0ba50105cb44cf23fe8cc40b8e42/6bdcf/ffmpeg-wasm-cover.png 315w,\n/static/899a0ba50105cb44cf23fe8cc40b8e42/f058b/ffmpeg-wasm-cover.png 630w,\n/static/899a0ba50105cb44cf23fe8cc40b8e42/6af66/ffmpeg-wasm-cover.png 640w\"\n        sizes=\"(max-width: 630px) 100vw, 630px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span></p>\n<p>In this part you will learn:</p>\n<ol>\n<li>Build a library version of FFmpeg with optimized arguments.</li>\n<li>Interact with ffmpeg.wasm</li>\n<li>Manage Emscripten File System.</li>\n<li>Develop ffmpeg.wasm v0.1 with transcoding feature.</li>\n</ol>\n<hr>\n<h2>Build a library version of FFmpeg with optimized arguments.</h2>\n<p>In Part.3, our goal is to create a basic ffmpeg.wasm v0.1 to transcode avi to mp4. As we only create a basic version of FFmpeg in Part.2, now we need to further optimized with few arguments.</p>\n<ol>\n<li><code class=\"language-text\">-O3</code> : optimize code and reduce code size (from 30 MB to 15 MB) (More details <a href=\"https://emscripten.org/docs/optimizing/Optimizing-Code.html\">HERE</a>)</li>\n<li><code class=\"language-text\">-s PROXY_TO_PTHREAD=1</code> : to make our program for responsive when using pthread (More details <a href=\"https://emscripten.org/docs/porting/pthreads.html#additional-flags\">HERE</a>)</li>\n<li><code class=\"language-text\">-o wasm/dist/ffmpeg-core.js</code> : rename ffmpeg.js to ffmpeg-core.js\n(From here we call it ffmpeg-core.js as we will create a ffmpeg.js library to wrap the ffmpeg-core.js and provide user friendly APIs.)</li>\n<li><code class=\"language-text\">-s EXPORTED_FUNCTIONS=&quot;[_main, _proxy_main]&quot;</code> : export main() and proxy<em>main() (added by PROXY</em>TO_PTHREAD) C function to JavaScript world</li>\n<li><code class=\"language-text\">-s EXTRA_EXPORTED_RUNTIME_METHODS=&quot;[FS, cwrap, setValue, writeAsciiToMemory]&quot;</code> : extra functions for manipulating functions, file system and pointers, check Interacting with code and preamble.js for more details.</li>\n</ol>\n<blockquote>\n<p>For more details about these arguments, you can check src/settings.js in emscripten github repository.</p>\n</blockquote>\n<p>With all the new arguments, letâ€™s update our <code class=\"language-text\">build.sh</code> :</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token shebang important\">#!/bin/bash -x</span>\n\n<span class=\"token comment\"># verify Emscripten version</span>\nemcc -v\n\n<span class=\"token comment\"># configure FFMpeg with Emscripten</span>\n<span class=\"token assign-left variable\">CFLAGS</span><span class=\"token operator\">=</span><span class=\"token string\">\"-s USE_PTHREADS -O3\"</span>\n<span class=\"token assign-left variable\">LDFLAGS</span><span class=\"token operator\">=</span><span class=\"token string\">\"<span class=\"token variable\">$CFLAGS</span> -s INITIAL_MEMORY=33554432\"</span> <span class=\"token comment\"># 33554432 bytes = 32 MB</span>\n<span class=\"token assign-left variable\">CONFIG_ARGS</span><span class=\"token operator\">=</span><span class=\"token punctuation\">(</span>\n  --target-os<span class=\"token operator\">=</span>none        <span class=\"token comment\"># use none to prevent any os specific configurations</span>\n  --arch<span class=\"token operator\">=</span>x86_32           <span class=\"token comment\"># use x86_32 to achieve minimal architectural optimization</span>\n  --enable-cross-compile  <span class=\"token comment\"># enable cross compile</span>\n  --disable-x86asm        <span class=\"token comment\"># disable x86 asm</span>\n  --disable-inline-asm    <span class=\"token comment\"># disable inline asm</span>\n  --disable-stripping     <span class=\"token comment\"># disable stripping</span>\n  --disable-programs      <span class=\"token comment\"># disable programs build (incl. ffplay, ffprobe &amp; ffmpeg)</span>\n  --disable-doc           <span class=\"token comment\"># disable doc</span>\n  --extra-cflags<span class=\"token operator\">=</span><span class=\"token string\">\"<span class=\"token variable\">$CFLAGS</span>\"</span>\n  --extra-cxxflags<span class=\"token operator\">=</span><span class=\"token string\">\"<span class=\"token variable\">$CFLAGS</span>\"</span>\n  --extra-ldflags<span class=\"token operator\">=</span><span class=\"token string\">\"<span class=\"token variable\">$LDFLAGS</span>\"</span>\n  --nm<span class=\"token operator\">=</span><span class=\"token string\">\"llvm-nm -g\"</span>\n  --ar<span class=\"token operator\">=</span>emar\n  --as<span class=\"token operator\">=</span>llvm-as\n  --ranlib<span class=\"token operator\">=</span>llvm-ranlib\n  --cc<span class=\"token operator\">=</span>emcc\n  --cxx<span class=\"token operator\">=</span>em++\n  --objcc<span class=\"token operator\">=</span>emcc\n  --dep-cc<span class=\"token operator\">=</span>emcc\n<span class=\"token punctuation\">)</span>\nemconfigure ./configure <span class=\"token string\">\"<span class=\"token variable\">${CONFIG_ARGS<span class=\"token punctuation\">[</span>@<span class=\"token punctuation\">]</span>}</span>\"</span>\n\n<span class=\"token comment\"># build dependencies</span>\nemmake <span class=\"token function\">make</span> -j4\n\n<span class=\"token comment\"># build ffmpeg.wasm</span>\n<span class=\"token function\">mkdir</span> -p wasm/dist\n<span class=\"token assign-left variable\">ARGS</span><span class=\"token operator\">=</span><span class=\"token punctuation\">(</span>\n  -I. -I./fftools\n  -Llibavcodec -Llibavdevice -Llibavfilter -Llibavformat -Llibavresample -Llibavutil -Llibpostproc -Llibswscale -Llibswresample\n  -Qunused-arguments\n  -o wasm/dist/ffmpeg.js fftools/ffmpeg_opt.c fftools/ffmpeg_filter.c fftools/ffmpeg_hw.c fftools/cmdutils.c fftools/ffmpeg.c\n  -lavdevice -lavfilter -lavformat -lavcodec -lswresample -lswscale -lavutil -lm\n  -O3                                           <span class=\"token comment\"># Optimize code with performance first</span>\n  -s <span class=\"token assign-left variable\">USE_SDL</span><span class=\"token operator\">=</span><span class=\"token number\">2</span>                                  <span class=\"token comment\"># use SDL2</span>\n  -s <span class=\"token assign-left variable\">USE_PTHREADS</span><span class=\"token operator\">=</span><span class=\"token number\">1</span>                             <span class=\"token comment\"># enable pthreads support</span>\n  -s <span class=\"token assign-left variable\">PROXY_TO_PTHREAD</span><span class=\"token operator\">=</span><span class=\"token number\">1</span>                         <span class=\"token comment\"># detach main() from browser/UI main thread</span>\n  -s <span class=\"token assign-left variable\">INVOKE_RUN</span><span class=\"token operator\">=</span><span class=\"token number\">0</span>                               <span class=\"token comment\"># not to run the main() in the beginning</span>\n  -s <span class=\"token assign-left variable\">EXPORTED_FUNCTIONS</span><span class=\"token operator\">=</span><span class=\"token string\">\"[_main, _proxy_main]\"</span>  <span class=\"token comment\"># export main and proxy_main funcs</span>\n  -s <span class=\"token assign-left variable\">EXTRA_EXPORTED_RUNTIME_METHODS</span><span class=\"token operator\">=</span><span class=\"token string\">\"[FS, cwrap, setValue, writeAsciiToMemory]\"</span>   <span class=\"token comment\"># export preamble funcs</span>\n  -s <span class=\"token assign-left variable\">INITIAL_MEMORY</span><span class=\"token operator\">=</span><span class=\"token number\">33554432</span>                    <span class=\"token comment\"># 33554432 bytes = 32 MB</span>\n<span class=\"token punctuation\">)</span>\nemcc <span class=\"token string\">\"<span class=\"token variable\">${ARGS<span class=\"token punctuation\">[</span>@<span class=\"token punctuation\">]</span>}</span>\"</span></code></pre></div>\n<p>Next, letâ€™s try to interact with ffmpeg.wasm.</p>\n<h2>Interact with ffmpeg.wasm</h2>\n<p>To make sure our ffmpeg.wasm is working, letâ€™s try to achieve following command in ffmpeg.wasm:</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">$ ffmpeg -hide_banner</code></pre></div>\n<p>With <code class=\"language-text\">-hide_banner</code> argument, ffmpeg hides details about its version and build arguments, a typical output looks like this:</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">Hyper fast Audio and Video encoder\nusage: ffmpeg [options] [[infile options] -i infile]... {[outfile options] outfile}...\nUse -h to get full help or, even better, run &#39;man ffmpeg&#39;</code></pre></div>\n<p>To begin with, letâ€™s create a file called <code class=\"language-text\">ffmpeg.js</code> with following code:</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token keyword\">const</span> Module <span class=\"token operator\">=</span> <span class=\"token function\">require</span><span class=\"token punctuation\">(</span><span class=\"token string\">'./dist/ffmpeg-core.js'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\nModule<span class=\"token punctuation\">.</span><span class=\"token function-variable function\">onRuntimeInitialized</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">const</span> ffmpeg <span class=\"token operator\">=</span> Module<span class=\"token punctuation\">.</span><span class=\"token function\">cwrap</span><span class=\"token punctuation\">(</span><span class=\"token string\">'proxy_main'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'number'</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">[</span><span class=\"token string\">'number'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'number'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>The execution of the code above requires extra parameters in Node.JS:</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">$ node --experimental-wasm-threads --experimental-wasm-bulk-memory ffmpeg.js</code></pre></div>\n<p>Explanation for the functions:</p>\n<ul>\n<li><code class=\"language-text\">onRuntimeInitialized</code> : as WebAssembly requires some time to boot up, you need to wait for this function to be called before using the library.</li>\n<li><code class=\"language-text\">cwrap</code> : a wrapper function for the C function in JavaScript world. Here we wrap proxy_main() / main() function in <code class=\"language-text\">fftools/ffmpeg.c</code>. The function signature is <code class=\"language-text\">int main(int argc, char **argv)</code>, it is straightforward that <code class=\"language-text\">int</code> is mapping to <code class=\"language-text\">number</code> and as <code class=\"language-text\">char **argv</code> is a pointer in C, we can also mapping it to <code class=\"language-text\">number</code>.</li>\n</ul>\n<p>Then we need to pass the arguments to it. The equivalent argument for <code class=\"language-text\">$ ffmpeg -hide_banner</code> is <code class=\"language-text\">main(2, [&quot;./ffmpeg&quot;, &quot;-hide_banner&quot;])</code>. The first argument is easy, but how can we pass a string array? Letâ€™s decompose the issue to two parts:</p>\n<ul>\n<li>We need to convert string in JavaScript to char array in C</li>\n<li>We need ot convert a number array in JavaScript to a pointer array in C</li>\n</ul>\n<p>The 1st part is easier as we have an utility function from Emscripten called <code class=\"language-text\">writeAsciiToMemory()</code> to help us, below is an example of using this function:</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token keyword\">const</span> str <span class=\"token operator\">=</span> <span class=\"token string\">\"FFmpeg.wasm\"</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">const</span> buf <span class=\"token operator\">=</span> Module<span class=\"token punctuation\">.</span><span class=\"token function\">_malloc</span><span class=\"token punctuation\">(</span>str<span class=\"token punctuation\">.</span>length <span class=\"token operator\">+</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// Allocate a memory with extra byte with value 0 to indicate the end of the string</span>\nModule<span class=\"token punctuation\">.</span><span class=\"token function\">writeAsciiToMemory</span><span class=\"token punctuation\">(</span>str<span class=\"token punctuation\">,</span> buf<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>The 2nd part is tricky, we need to create a pointer array in C with 32 bit integer as the pointer is in 32 bit integer. We need to use setValue here to create the array we need:</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token keyword\">const</span> ptrs <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span><span class=\"token number\">123</span><span class=\"token punctuation\">,</span> <span class=\"token number\">3455</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">const</span> buf <span class=\"token operator\">=</span> Module<span class=\"token punctuation\">.</span><span class=\"token function\">_malloc</span><span class=\"token punctuation\">(</span>ptrs<span class=\"token punctuation\">.</span>length <span class=\"token operator\">*</span> Uint32Array<span class=\"token punctuation\">.</span><span class=\"token constant\">BYTES_PER_ELEMENT</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\nptrs<span class=\"token punctuation\">.</span><span class=\"token function\">forEach</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">p<span class=\"token punctuation\">,</span> idx</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n  Module<span class=\"token punctuation\">.</span><span class=\"token function\">setValue</span><span class=\"token punctuation\">(</span>buf <span class=\"token operator\">+</span> <span class=\"token punctuation\">(</span>Uint32Array<span class=\"token punctuation\">.</span><span class=\"token constant\">BYTES_PER_ELEMENT</span> <span class=\"token operator\">*</span> idx<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> p<span class=\"token punctuation\">,</span> <span class=\"token string\">'i32'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>Merge all the snippets above, now we can interact with ffmpeg.wasm and generate expected result:</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token keyword\">const</span> Module <span class=\"token operator\">=</span> <span class=\"token function\">require</span><span class=\"token punctuation\">(</span><span class=\"token string\">'./dist/ffmpeg-core'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\nModule<span class=\"token punctuation\">.</span><span class=\"token function-variable function\">onRuntimeInitialized</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">const</span> ffmpeg <span class=\"token operator\">=</span> Module<span class=\"token punctuation\">.</span><span class=\"token function\">cwrap</span><span class=\"token punctuation\">(</span><span class=\"token string\">'proxy_main'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'number'</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">[</span><span class=\"token string\">'number'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'number'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">const</span> args <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span><span class=\"token string\">'ffmpeg'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'-hide_banner'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">const</span> argsPtr <span class=\"token operator\">=</span> Module<span class=\"token punctuation\">.</span><span class=\"token function\">_malloc</span><span class=\"token punctuation\">(</span>args<span class=\"token punctuation\">.</span>length <span class=\"token operator\">*</span> Uint32Array<span class=\"token punctuation\">.</span><span class=\"token constant\">BYTES_PER_ELEMENT</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  args<span class=\"token punctuation\">.</span><span class=\"token function\">forEach</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">s<span class=\"token punctuation\">,</span> idx</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">const</span> buf <span class=\"token operator\">=</span> Module<span class=\"token punctuation\">.</span><span class=\"token function\">_malloc</span><span class=\"token punctuation\">(</span>s<span class=\"token punctuation\">.</span>length <span class=\"token operator\">+</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    Module<span class=\"token punctuation\">.</span><span class=\"token function\">writeAsciiToMemory</span><span class=\"token punctuation\">(</span>s<span class=\"token punctuation\">,</span> buf<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    Module<span class=\"token punctuation\">.</span><span class=\"token function\">setValue</span><span class=\"token punctuation\">(</span>argsPtr <span class=\"token operator\">+</span> <span class=\"token punctuation\">(</span>Uint32Array<span class=\"token punctuation\">.</span><span class=\"token constant\">BYTES_PER_ELEMENT</span> <span class=\"token operator\">*</span> idx<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> buf<span class=\"token punctuation\">,</span> <span class=\"token string\">'i32'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n  <span class=\"token function\">ffmpeg</span><span class=\"token punctuation\">(</span>args<span class=\"token punctuation\">.</span>length<span class=\"token punctuation\">,</span> argsPtr<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>Now, we can interact with ffmpeg.wasm with ease, but how can we pass the video file to it? That is the focus of next section: File System.</p>\n<h2>Manage Emscripten File System.</h2>\n<p>In Emscripten, there is a virtual file system to support standard file read/write in C, thus we need to write our video file into this File System before passing the arguments to ffmpeg.wasm.</p>\n<blockquote>\n<p>Find more details in <a href=\"https://emscripten.org/docs/api_reference/Filesystem-API.html\">File System API</a>.</p>\n</blockquote>\n<p>Most of the time, there are only 2 FS functions you need to complete the task: <code class=\"language-text\">FS.writeFile()</code> and <code class=\"language-text\">FS.readFile()</code> .</p>\n<p>For all the data writing to or reading from the File System, it must be in Uint8Array type in JavaScript, remember to do type conversion before consuming the data.</p>\n<p>For this tutorial, letâ€™s use a file called flame.avi (You can download it <a href=\"https://github.com/ffmpegwasm/testdata/raw/master/flame.avi\">HERE</a>) and read it with <code class=\"language-text\">fs.readFileSync()</code> and write it to Emscripten File System with <code class=\"language-text\">FS.writeFile()</code> .</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token keyword\">const</span> fs <span class=\"token operator\">=</span> <span class=\"token function\">require</span><span class=\"token punctuation\">(</span><span class=\"token string\">'fs'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">const</span> Module <span class=\"token operator\">=</span> <span class=\"token function\">require</span><span class=\"token punctuation\">(</span><span class=\"token string\">'./dist/ffmpeg-core'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\nModule<span class=\"token punctuation\">.</span><span class=\"token function-variable function\">onRuntimeInitialized</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">const</span> data <span class=\"token operator\">=</span> Uint8Array<span class=\"token punctuation\">.</span><span class=\"token function\">from</span><span class=\"token punctuation\">(</span>fs<span class=\"token punctuation\">.</span><span class=\"token function\">readFileSync</span><span class=\"token punctuation\">(</span><span class=\"token string\">'./flame.avi'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  Module<span class=\"token punctuation\">.</span><span class=\"token constant\">FS</span><span class=\"token punctuation\">.</span><span class=\"token function\">writeFile</span><span class=\"token punctuation\">(</span><span class=\"token string\">'flame.avi'</span><span class=\"token punctuation\">,</span> data<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n  <span class=\"token keyword\">const</span> ffmpeg <span class=\"token operator\">=</span> Module<span class=\"token punctuation\">.</span><span class=\"token function\">cwrap</span><span class=\"token punctuation\">(</span><span class=\"token string\">'proxy_main'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'number'</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">[</span><span class=\"token string\">'number'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'number'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">const</span> args <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span><span class=\"token string\">'ffmpeg'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'-hide_banner'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">const</span> argsPtr <span class=\"token operator\">=</span> Module<span class=\"token punctuation\">.</span><span class=\"token function\">_malloc</span><span class=\"token punctuation\">(</span>args<span class=\"token punctuation\">.</span>length <span class=\"token operator\">*</span> Uint32Array<span class=\"token punctuation\">.</span><span class=\"token constant\">BYTES_PER_ELEMENT</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  args<span class=\"token punctuation\">.</span><span class=\"token function\">forEach</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">s<span class=\"token punctuation\">,</span> idx</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">const</span> buf <span class=\"token operator\">=</span> Module<span class=\"token punctuation\">.</span><span class=\"token function\">_malloc</span><span class=\"token punctuation\">(</span>s<span class=\"token punctuation\">.</span>length <span class=\"token operator\">+</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    Module<span class=\"token punctuation\">.</span><span class=\"token function\">writeAsciiToMemory</span><span class=\"token punctuation\">(</span>s<span class=\"token punctuation\">,</span> buf<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    Module<span class=\"token punctuation\">.</span><span class=\"token function\">setValue</span><span class=\"token punctuation\">(</span>argsPtr <span class=\"token operator\">+</span> <span class=\"token punctuation\">(</span>Uint32Array<span class=\"token punctuation\">.</span><span class=\"token constant\">BYTES_PER_ELEMENT</span> <span class=\"token operator\">*</span> idx<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> buf<span class=\"token punctuation\">,</span> <span class=\"token string\">'i32'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n  <span class=\"token function\">ffmpeg</span><span class=\"token punctuation\">(</span>args<span class=\"token punctuation\">.</span>length<span class=\"token punctuation\">,</span> argsPtr<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span></code></pre></div>\n<h2>Develop ffmpeg.wasm v0.1 with transcoding feature.</h2>\n<p>Now we are able to pass arguments to ffmpeg.wasm and save files to File System, letâ€™s compose all of them together and get our ffmpeg.wasm v0.1 working.</p>\n<p>The last one more detail we need to be aware of is that <code class=\"language-text\">ffmpeg()</code> above is actually running asynchronously, so to get the output file we need to use a <code class=\"language-text\">setInterval()</code> to parse the log file to know if the tranding completes.</p>\n<p>Put everything together, now we have our first ffmpeg.wasm to transcode a avi file to mp4 file with any issues:</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token keyword\">const</span> fs <span class=\"token operator\">=</span> <span class=\"token function\">require</span><span class=\"token punctuation\">(</span><span class=\"token string\">'fs'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">const</span> Module <span class=\"token operator\">=</span> <span class=\"token function\">require</span><span class=\"token punctuation\">(</span><span class=\"token string\">'./dist/ffmpeg-core'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\nModule<span class=\"token punctuation\">.</span><span class=\"token function-variable function\">onRuntimeInitialized</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">const</span> data <span class=\"token operator\">=</span> Uint8Array<span class=\"token punctuation\">.</span><span class=\"token function\">from</span><span class=\"token punctuation\">(</span>fs<span class=\"token punctuation\">.</span><span class=\"token function\">readFileSync</span><span class=\"token punctuation\">(</span><span class=\"token string\">'./flame.avi'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  Module<span class=\"token punctuation\">.</span><span class=\"token constant\">FS</span><span class=\"token punctuation\">.</span><span class=\"token function\">writeFile</span><span class=\"token punctuation\">(</span><span class=\"token string\">'flame.avi'</span><span class=\"token punctuation\">,</span> data<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n  <span class=\"token keyword\">const</span> ffmpeg <span class=\"token operator\">=</span> Module<span class=\"token punctuation\">.</span><span class=\"token function\">cwrap</span><span class=\"token punctuation\">(</span><span class=\"token string\">'proxy_main'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'number'</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">[</span><span class=\"token string\">'number'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'number'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">const</span> args <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span><span class=\"token string\">'ffmpeg'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'-hide_banner'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'-report'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'-i'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'flame.avi'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'flame.mp4'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">const</span> argsPtr <span class=\"token operator\">=</span> Module<span class=\"token punctuation\">.</span><span class=\"token function\">_malloc</span><span class=\"token punctuation\">(</span>args<span class=\"token punctuation\">.</span>length <span class=\"token operator\">*</span> Uint32Array<span class=\"token punctuation\">.</span><span class=\"token constant\">BYTES_PER_ELEMENT</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  args<span class=\"token punctuation\">.</span><span class=\"token function\">forEach</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">s<span class=\"token punctuation\">,</span> idx</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">const</span> buf <span class=\"token operator\">=</span> Module<span class=\"token punctuation\">.</span><span class=\"token function\">_malloc</span><span class=\"token punctuation\">(</span>s<span class=\"token punctuation\">.</span>length <span class=\"token operator\">+</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    Module<span class=\"token punctuation\">.</span><span class=\"token function\">writeAsciiToMemory</span><span class=\"token punctuation\">(</span>s<span class=\"token punctuation\">,</span> buf<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    Module<span class=\"token punctuation\">.</span><span class=\"token function\">setValue</span><span class=\"token punctuation\">(</span>argsPtr <span class=\"token operator\">+</span> <span class=\"token punctuation\">(</span>Uint32Array<span class=\"token punctuation\">.</span><span class=\"token constant\">BYTES_PER_ELEMENT</span> <span class=\"token operator\">*</span> idx<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> buf<span class=\"token punctuation\">,</span> <span class=\"token string\">'i32'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token function\">ffmpeg</span><span class=\"token punctuation\">(</span>args<span class=\"token punctuation\">.</span>length<span class=\"token punctuation\">,</span> argsPtr<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n  <span class=\"token comment\">/*\n   * The execution of ffmpeg is not synchronized,\n   * so we need to parse the log file to check if completed.\n   */</span>\n  <span class=\"token keyword\">const</span> timer <span class=\"token operator\">=</span> <span class=\"token function\">setInterval</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">const</span> logFileName <span class=\"token operator\">=</span> Module<span class=\"token punctuation\">.</span><span class=\"token constant\">FS</span><span class=\"token punctuation\">.</span><span class=\"token function\">readdir</span><span class=\"token punctuation\">(</span><span class=\"token string\">'.'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">find</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">name</span> <span class=\"token operator\">=></span> name<span class=\"token punctuation\">.</span><span class=\"token function\">endsWith</span><span class=\"token punctuation\">(</span><span class=\"token string\">'.log'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">typeof</span> logFileName <span class=\"token operator\">!==</span> <span class=\"token string\">'undefined'</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token keyword\">const</span> log <span class=\"token operator\">=</span> String<span class=\"token punctuation\">.</span><span class=\"token function\">fromCharCode</span><span class=\"token punctuation\">.</span><span class=\"token function\">apply</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">null</span><span class=\"token punctuation\">,</span> Module<span class=\"token punctuation\">.</span><span class=\"token constant\">FS</span><span class=\"token punctuation\">.</span><span class=\"token function\">readFile</span><span class=\"token punctuation\">(</span>logFileName<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n      <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>log<span class=\"token punctuation\">.</span><span class=\"token function\">includes</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"frames successfully decoded\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token function\">clearInterval</span><span class=\"token punctuation\">(</span>timer<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">const</span> output <span class=\"token operator\">=</span> Module<span class=\"token punctuation\">.</span><span class=\"token constant\">FS</span><span class=\"token punctuation\">.</span><span class=\"token function\">readFile</span><span class=\"token punctuation\">(</span><span class=\"token string\">'flame.mp4'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        fs<span class=\"token punctuation\">.</span><span class=\"token function\">writeFileSync</span><span class=\"token punctuation\">(</span><span class=\"token string\">'flame.mp4'</span><span class=\"token punctuation\">,</span> output<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n      <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span> <span class=\"token number\">500</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>You can visit the repository here to see how it works in details: <a href=\"https://github.com/ffmpegwasm/FFmpeg/tree/n4.3.1-p3\">https://github.com/ffmpegwasm/FFmpeg/tree/n4.3.1-p3</a></p>\n<p>And feel free to download the build artifacts here: <a href=\"https://github.com/ffmpegwasm/FFmpeg/releases/tag/n4.3.1-p3\">https://github.com/ffmpegwasm/FFmpeg/releases/tag/n4.3.1-p3</a></p>\n<hr>\n<p>Please note currently it is a Node.js only version, but we will develop a browser version in next post.</p>\n<p>Look forward to seeing you in Part.4. ðŸ˜ƒ</p>","frontmatter":{"title":"Build FFmpeg WebAssembly version (= ffmpeg.wasm): Part.3 ffmpeg.wasm v0.1 â€” Transcoding avi to mp4","date":"October 21, 2019","description":"A series of tutorials of using Emscripten to build ffmpeg"}}},"pageContext":{"slug":"/build-ffmpeg-webassembly-version-part-3-v0.1/","previous":{"fields":{"slug":"/build-ffmpeg-webassembly-version-part-2-compile-with-emscripten/"},"frontmatter":{"title":"Build FFmpeg WebAssembly version (= ffmpeg.wasm): Part.2 Compile with Emscripten"}},"next":{"fields":{"slug":"/how-to-speed-up-node-js-modules-installation/"},"frontmatter":{"title":"How to speed up Node.js modules installation in CI/CD pipeline as of 2020"}}}},"staticQueryHashes":["2841359383","916993862"]}