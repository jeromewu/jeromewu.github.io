{"componentChunkName":"component---src-templates-blog-post-js","path":"/build-ffmpeg-webassembly-version-part-4-v0.2/","result":{"data":{"site":{"siteMetadata":{"title":"TechBlog"}},"markdownRemark":{"id":"fa4d546c-a083-5ebf-8daa-12b9fac68a33","excerpt":"In this part you will learn: Add Libx264 to ffmpeg-core.js In browser ffmpeg.wasm demo Add Libx264 to ffmpeg-core.js For next step, we would like to transcodeâ€¦","html":"<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 630px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/899a0ba50105cb44cf23fe8cc40b8e42/6af66/ffmpeg-wasm-cover.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 56.32911392405063%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAALCAIAAADwazoUAAAACXBIWXMAAAsTAAALEwEAmpwYAAABa0lEQVQoz52RsUrDUBSG+zCugg8guPoKQl9BAtVC0UWq7eTUJUhpohVzSzIkNIPQpTZDRUpxspChg0OTqEmT3phAenPvFZuaBlsc/MYD3zk//8nRH6I4uuryO9Xdk/uzvtYvn5fb7bZlWY7jQAh933ddNwgCmiFHKSWUUEqDebBX29+62D5Uj0VBLBwV+Gu+VCoxDFMsFvP5PMMwAABKaRzHG+TbocA+1i97NWc6tW3b8zzTNHsLDMMAAHQ6HUopxngl/5uVTChGcYQwwgQnu4MgkGU5DEOcYbO82kK+bUJIFEW6riOEkqhkQdbPpYI9G1nTJxhOljky+J9+HMeJvOEyQmgwPtX0g/GbNByMGo06z/OKokiSpKoqAIBl2QbHSZLEc1zyMJLKczQ3nJeJ/fzhvXYftJtm804QQKslSmJP02RZrlQrsqIIiyH0/STsUsYEO65tvZvQn623EIYhhPCvttcLS0v6NUzlL8i3UGQPK6VDAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"ffmpeg wasm cover\"\n        title=\"ffmpeg wasm cover\"\n        src=\"/static/899a0ba50105cb44cf23fe8cc40b8e42/f058b/ffmpeg-wasm-cover.png\"\n        srcset=\"/static/899a0ba50105cb44cf23fe8cc40b8e42/c26ae/ffmpeg-wasm-cover.png 158w,\n/static/899a0ba50105cb44cf23fe8cc40b8e42/6bdcf/ffmpeg-wasm-cover.png 315w,\n/static/899a0ba50105cb44cf23fe8cc40b8e42/f058b/ffmpeg-wasm-cover.png 630w,\n/static/899a0ba50105cb44cf23fe8cc40b8e42/6af66/ffmpeg-wasm-cover.png 640w\"\n        sizes=\"(max-width: 630px) 100vw, 630px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span></p>\n<p>In this part you will learn:</p>\n<ol>\n<li>Add Libx264 to ffmpeg-core.js</li>\n<li>In browser ffmpeg.wasm demo</li>\n</ol>\n<hr>\n<h2>Add Libx264 to ffmpeg-core.js</h2>\n<p>For next step, we would like to transcode an avi video and play it in our web browser. By default ffmpeg-core.js can transcode avi to mp4, but that mp4 file cannot be played in web browser as its encoding is not supported. So we need to add libx264 to our ffmpeg-core.js first.</p>\n<p>Below is the link to the x264 library we are going to add:</p>\n<p><a href=\"https://code.videolan.org/videolan/x264\">https://code.videolan.org/videolan/x264</a></p>\n<p><code class=\"language-text\">x264</code> is much easier to build compared to ffmpeg, below are the key arguments you need to pass:</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token shebang important\">#!/bin/bash -x</span>\n\n<span class=\"token assign-left variable\">ARGS</span><span class=\"token operator\">=</span><span class=\"token punctuation\">(</span>\n  --host<span class=\"token operator\">=</span>i686-gnu                     <span class=\"token comment\"># use i686 gnu</span>\n  --enable-static                     <span class=\"token comment\"># enable building static library</span>\n  --disable-cli                       <span class=\"token comment\"># disable cli tools</span>\n  --disable-asm                       <span class=\"token comment\"># disable asm optimization</span>\n  --extra-cflags<span class=\"token operator\">=</span><span class=\"token string\">\"-s USE_PTHREADS=1\"</span>  <span class=\"token comment\"># pass this flags for using pthreads</span>\n<span class=\"token punctuation\">)</span>\nemconfigure ./configure <span class=\"token string\">\"<span class=\"token variable\">${ARGS<span class=\"token punctuation\">[</span>@<span class=\"token punctuation\">]</span>}</span>\"</span></code></pre></div>\n<blockquote>\n<p>Check the repository for the full version of <a href=\"https://github.com/ffmpegwasm/FFmpeg/blob/n4.3.1-p4/wasm/build-scripts/build-x264.sh\">build-x264.sh</a></p>\n</blockquote>\n<p>While configuring ffmpeg, <code class=\"language-text\">--enable-gpl</code> and <code class=\"language-text\">--enable-libx264</code> flags must be added.</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token shebang important\">#!/bin/bash -x</span>\n\n<span class=\"token comment\"># ...</span>\n\n<span class=\"token assign-left variable\">CONFIG_ARGS</span><span class=\"token operator\">=</span><span class=\"token punctuation\">(</span>\n  --target-os<span class=\"token operator\">=</span>none        <span class=\"token comment\"># use none to prevent any os specific configurations</span>\n  --arch<span class=\"token operator\">=</span>x86_32           <span class=\"token comment\"># use x86_32 to achieve minimal architectural optimization</span>\n  --enable-cross-compile  <span class=\"token comment\"># enable cross compile</span>\n  --disable-x86asm        <span class=\"token comment\"># disable x86 asm</span>\n  --disable-inline-asm    <span class=\"token comment\"># disable inline asm</span>\n  --disable-stripping     <span class=\"token comment\"># disable stripping</span>\n  --disable-programs      <span class=\"token comment\"># disable programs build (incl. ffplay, ffprobe &amp; ffmpeg)</span>\n  --disable-doc           <span class=\"token comment\"># disable doc</span>\n  --enable-gpl            <span class=\"token comment\">## required by x264</span>\n  --enable-libx264        <span class=\"token comment\">## enable x264</span>\n  --extra-cflags<span class=\"token operator\">=</span><span class=\"token string\">\"<span class=\"token variable\">$CFLAGS</span>\"</span>\n  --extra-cxxflags<span class=\"token operator\">=</span><span class=\"token string\">\"<span class=\"token variable\">$CFLAGS</span>\"</span>\n  --extra-ldflags<span class=\"token operator\">=</span><span class=\"token string\">\"<span class=\"token variable\">$LDFLAGS</span>\"</span>\n  --nm<span class=\"token operator\">=</span><span class=\"token string\">\"llvm-nm -g\"</span>\n  --ar<span class=\"token operator\">=</span>emar\n  --as<span class=\"token operator\">=</span>llvm-as\n  --ranlib<span class=\"token operator\">=</span>llvm-ranlib\n  --cc<span class=\"token operator\">=</span>emcc\n  --cxx<span class=\"token operator\">=</span>em++\n  --objcc<span class=\"token operator\">=</span>emcc\n  --dep-cc<span class=\"token operator\">=</span>emcc\n<span class=\"token punctuation\">)</span>\nemconfigure ./configure <span class=\"token string\">\"<span class=\"token variable\">${CONFIG_ARGS<span class=\"token punctuation\">[</span>@<span class=\"token punctuation\">]</span>}</span>\"</span>\n\n<span class=\"token comment\"># ...</span>\n\n<span class=\"token assign-left variable\">ARGS</span><span class=\"token operator\">=</span><span class=\"token punctuation\">(</span>\n  -I. -I./fftools -I<span class=\"token variable\">$BUILD_DIR</span>/include\n  -Llibavcodec -Llibavdevice -Llibavfilter -Llibavformat -Llibavresample -Llibavutil -Llibpostproc -Llibswscale -Llibswresample -L<span class=\"token variable\">$BUILD_DIR</span>/lib\n  -Qunused-arguments\n  -o wasm/dist/ffmpeg-core.js fftools/ffmpeg_opt.c fftools/ffmpeg_filter.c fftools/ffmpeg_hw.c fftools/cmdutils.c fftools/ffmpeg.c\n  <span class=\"token comment\"># Add -lpostproc and -lx264 below</span>\n  -lavdevice -lavfilter -lavformat -lavcodec -lswresample -lswscale -lavutil -lpostproc -lm -lx264 -pthread\n  -O3                                           <span class=\"token comment\"># Optimize code with performance first</span>\n  -s <span class=\"token assign-left variable\">USE_SDL</span><span class=\"token operator\">=</span><span class=\"token number\">2</span>                                  <span class=\"token comment\"># use SDL2</span>\n  -s <span class=\"token assign-left variable\">USE_PTHREADS</span><span class=\"token operator\">=</span><span class=\"token number\">1</span>                             <span class=\"token comment\"># enable pthreads support</span>\n  -s <span class=\"token assign-left variable\">PROXY_TO_PTHREAD</span><span class=\"token operator\">=</span><span class=\"token number\">1</span>                         <span class=\"token comment\"># detach main() from browser/UI main thread</span>\n  -s <span class=\"token assign-left variable\">INVOKE_RUN</span><span class=\"token operator\">=</span><span class=\"token number\">0</span>                               <span class=\"token comment\"># not to run the main() in the beginning</span>\n  -s <span class=\"token assign-left variable\">EXPORTED_FUNCTIONS</span><span class=\"token operator\">=</span><span class=\"token string\">\"[_main, _proxy_main]\"</span>  <span class=\"token comment\"># export main and proxy_main funcs</span>\n  -s <span class=\"token assign-left variable\">EXTRA_EXPORTED_RUNTIME_METHODS</span><span class=\"token operator\">=</span><span class=\"token string\">\"[FS, cwrap, setValue, writeAsciiToMemory]\"</span>   <span class=\"token comment\"># export preamble funcs</span>\n  -s <span class=\"token assign-left variable\">INITIAL_MEMORY</span><span class=\"token operator\">=</span><span class=\"token number\">268435456</span>                   <span class=\"token comment\">## increase to 268435456 bytes = 256 MB</span>\n<span class=\"token punctuation\">)</span>\nemcc <span class=\"token string\">\"<span class=\"token variable\">${ARGS<span class=\"token punctuation\">[</span>@<span class=\"token punctuation\">]</span>}</span>\"</span></code></pre></div>\n<blockquote>\n<p>Check the repository for the full version of <a href=\"https://github.com/ffmpegwasm/FFmpeg/blob/n4.3.1-p4/wasm/build-scripts/configure.sh\">configure.sh</a> and <a href=\"https://github.com/ffmpegwasm/FFmpeg/blob/n4.3.1-p4/wasm/build-scripts/build-ffmpeg.sh\">build-ffmpeg.sh</a></p>\n</blockquote>\n<p>With all script in place, now you can build a ffmpeg.wasm with x264 (and potentially all other libraries.)</p>\n<h2>In browser ffmpeg.wasm demo</h2>\n<p>The final part of this story is a demo for ffmpeg.wasm v0.2, the scenario is to create a web page that enables user to upload a video file (ex. avi) and play inside the web browser. As it is not possible to play avi file directly, we will use ffmpeg.wasm to transcode the video first:</p>\n<p><img src=\"/3f49f83bb3354af398ab27f13db821ab/demo.gif\" alt=\"\"></p>\n<p>Below is the full HTML code (download sample video <a href=\"https://github.com/ffmpegwasm/ffmpeg.wasm/raw/master/tests/assets/flame.avi\">HERE</a>):</p>\n<div class=\"gatsby-highlight\" data-language=\"html\"><pre class=\"language-html\"><code class=\"language-html\"><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>html</span><span class=\"token punctuation\">></span></span>                                                                                                                                            \n  <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>head</span><span class=\"token punctuation\">></span></span>                                                                                                                                          \n    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>style</span><span class=\"token punctuation\">></span></span><span class=\"token style\"><span class=\"token language-css\">                                                                                                                                       \n      <span class=\"token selector\">html, body</span> <span class=\"token punctuation\">{</span>                                                       \n        <span class=\"token property\">margin</span><span class=\"token punctuation\">:</span> 0<span class=\"token punctuation\">;</span>                                                       \n        <span class=\"token property\">width</span><span class=\"token punctuation\">:</span> 100%<span class=\"token punctuation\">;</span>                                                     \n        <span class=\"token property\">height</span><span class=\"token punctuation\">:</span> 100%                                                     \n      <span class=\"token punctuation\">}</span>                                                                  \n      <span class=\"token selector\">body</span> <span class=\"token punctuation\">{</span>                                                                                                                                      \n        <span class=\"token property\">display</span><span class=\"token punctuation\">:</span> flex<span class=\"token punctuation\">;</span>                                                   \n        <span class=\"token property\">flex-direction</span><span class=\"token punctuation\">:</span> column<span class=\"token punctuation\">;</span>\n        <span class=\"token property\">align-items</span><span class=\"token punctuation\">:</span> center<span class=\"token punctuation\">;</span>                                             \n      <span class=\"token punctuation\">}</span>   \n    </span></span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>style</span><span class=\"token punctuation\">></span></span>                                                                                                                                      \n  <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>head</span><span class=\"token punctuation\">></span></span>                                                                \n  <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>body</span><span class=\"token punctuation\">></span></span>                                                                 \n    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>h3</span><span class=\"token punctuation\">></span></span>Upload a video to transcode to mp4 (x264) and play!<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>h3</span><span class=\"token punctuation\">></span></span>\n    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>video</span> <span class=\"token attr-name\">id</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>output-video<span class=\"token punctuation\">\"</span></span> <span class=\"token attr-name\">controls</span><span class=\"token punctuation\">></span></span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>video</span><span class=\"token punctuation\">></span></span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>br</span><span class=\"token punctuation\">/></span></span> \n    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>input</span> <span class=\"token attr-name\">type</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>file<span class=\"token punctuation\">\"</span></span> <span class=\"token attr-name\">id</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>uploader<span class=\"token punctuation\">\"</span></span><span class=\"token punctuation\">></span></span>                   \n    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>p</span> <span class=\"token attr-name\">id</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>message<span class=\"token punctuation\">\"</span></span><span class=\"token punctuation\">></span></span>Remeber to wait for 5 seconds for ffmpeg.wasm to load<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>p</span><span class=\"token punctuation\">></span></span>\n    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>script</span> <span class=\"token attr-name\">type</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>text/javascript<span class=\"token punctuation\">\"</span></span><span class=\"token punctuation\">></span></span><span class=\"token script\"><span class=\"token language-javascript\">                                                                                                               \n      <span class=\"token keyword\">const</span> <span class=\"token function-variable function\">readFromBlobOrFile</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">blob</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">(</span>\n        <span class=\"token keyword\">new</span> <span class=\"token class-name\">Promise</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">resolve<span class=\"token punctuation\">,</span> reject</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n          <span class=\"token keyword\">const</span> fileReader <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">FileReader</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n          fileReader<span class=\"token punctuation\">.</span><span class=\"token function-variable function\">onload</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n            <span class=\"token function\">resolve</span><span class=\"token punctuation\">(</span>fileReader<span class=\"token punctuation\">.</span>result<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n          <span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n          fileReader<span class=\"token punctuation\">.</span><span class=\"token function-variable function\">onerror</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\"><span class=\"token punctuation\">{</span> <span class=\"token literal-property property\">target</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span> <span class=\"token literal-property property\">error</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span> code <span class=\"token punctuation\">}</span> <span class=\"token punctuation\">}</span> <span class=\"token punctuation\">}</span></span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n            <span class=\"token function\">reject</span><span class=\"token punctuation\">(</span><span class=\"token function\">Error</span><span class=\"token punctuation\">(</span><span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token string\">File could not be read! Code=</span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span>code<span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token template-punctuation string\">`</span></span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n          <span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n          fileReader<span class=\"token punctuation\">.</span><span class=\"token function\">readAsArrayBuffer</span><span class=\"token punctuation\">(</span>blob<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n      <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n      <span class=\"token keyword\">const</span> message <span class=\"token operator\">=</span> document<span class=\"token punctuation\">.</span><span class=\"token function\">getElementById</span><span class=\"token punctuation\">(</span><span class=\"token string\">'message'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n      <span class=\"token keyword\">const</span> <span class=\"token function-variable function\">transcode</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">async</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\"><span class=\"token punctuation\">{</span> <span class=\"token literal-property property\">target</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span> files <span class=\"token punctuation\">}</span> <span class=\"token punctuation\">}</span></span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">const</span> <span class=\"token punctuation\">{</span> name <span class=\"token punctuation\">}</span> <span class=\"token operator\">=</span> files<span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>\n        message<span class=\"token punctuation\">.</span>innerHTML <span class=\"token operator\">=</span> <span class=\"token string\">'Writing file to MEMFS'</span><span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">const</span> data <span class=\"token operator\">=</span> <span class=\"token keyword\">await</span> <span class=\"token function\">readFromBlobOrFile</span><span class=\"token punctuation\">(</span>files<span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>                                                                                          \n        Module<span class=\"token punctuation\">.</span><span class=\"token constant\">FS</span><span class=\"token punctuation\">.</span><span class=\"token function\">writeFile</span><span class=\"token punctuation\">(</span>name<span class=\"token punctuation\">,</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Uint8Array</span><span class=\"token punctuation\">(</span>data<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>                                                                                          \n        <span class=\"token keyword\">const</span> ffmpeg <span class=\"token operator\">=</span> Module<span class=\"token punctuation\">.</span><span class=\"token function\">cwrap</span><span class=\"token punctuation\">(</span><span class=\"token string\">'proxy_main'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'number'</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">[</span><span class=\"token string\">'number'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'number'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">const</span> args <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span><span class=\"token string\">'ffmpeg'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'-hide_banner'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'-nostdin'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'-report'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'-i'</span><span class=\"token punctuation\">,</span> name<span class=\"token punctuation\">,</span> <span class=\"token string\">'out.mp4'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">const</span> argsPtr <span class=\"token operator\">=</span> Module<span class=\"token punctuation\">.</span><span class=\"token function\">_malloc</span><span class=\"token punctuation\">(</span>args<span class=\"token punctuation\">.</span>length <span class=\"token operator\">*</span> Uint32Array<span class=\"token punctuation\">.</span><span class=\"token constant\">BYTES_PER_ELEMENT</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        args<span class=\"token punctuation\">.</span><span class=\"token function\">forEach</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">s<span class=\"token punctuation\">,</span> idx</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>                                       \n          <span class=\"token keyword\">const</span> buf <span class=\"token operator\">=</span> Module<span class=\"token punctuation\">.</span><span class=\"token function\">_malloc</span><span class=\"token punctuation\">(</span>s<span class=\"token punctuation\">.</span>length <span class=\"token operator\">+</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>                      \n          Module<span class=\"token punctuation\">.</span><span class=\"token function\">writeAsciiToMemory</span><span class=\"token punctuation\">(</span>s<span class=\"token punctuation\">,</span> buf<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>                                                                                                      \n          Module<span class=\"token punctuation\">.</span><span class=\"token function\">setValue</span><span class=\"token punctuation\">(</span>argsPtr <span class=\"token operator\">+</span> <span class=\"token punctuation\">(</span>Uint32Array<span class=\"token punctuation\">.</span><span class=\"token constant\">BYTES_PER_ELEMENT</span> <span class=\"token operator\">*</span> idx<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> buf<span class=\"token punctuation\">,</span> <span class=\"token string\">'i32'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>                    \n        message<span class=\"token punctuation\">.</span>innerHTML <span class=\"token operator\">=</span> <span class=\"token string\">'Start to transcode'</span><span class=\"token punctuation\">;</span>                        \n        <span class=\"token function\">ffmpeg</span><span class=\"token punctuation\">(</span>args<span class=\"token punctuation\">.</span>length<span class=\"token punctuation\">,</span> argsPtr<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n        <span class=\"token comment\">/*                                                               \n         * The execution of ffmpeg is not synchronized,                  \n         * so we need to parse the log file to check if completed.\n         */</span>                                                              \n        <span class=\"token keyword\">const</span> timer <span class=\"token operator\">=</span> <span class=\"token function\">setInterval</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>               \n          <span class=\"token keyword\">const</span> logFileName <span class=\"token operator\">=</span> Module<span class=\"token punctuation\">.</span><span class=\"token constant\">FS</span><span class=\"token punctuation\">.</span><span class=\"token function\">readdir</span><span class=\"token punctuation\">(</span><span class=\"token string\">'.'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">find</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">name</span> <span class=\"token operator\">=></span> name<span class=\"token punctuation\">.</span><span class=\"token function\">endsWith</span><span class=\"token punctuation\">(</span><span class=\"token string\">'.log'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n          <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">typeof</span> logFileName <span class=\"token operator\">!==</span> <span class=\"token string\">'undefined'</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>                                                                                               \n            <span class=\"token keyword\">const</span> log <span class=\"token operator\">=</span> String<span class=\"token punctuation\">.</span><span class=\"token function\">fromCharCode</span><span class=\"token punctuation\">.</span><span class=\"token function\">apply</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">null</span><span class=\"token punctuation\">,</span> Module<span class=\"token punctuation\">.</span><span class=\"token constant\">FS</span><span class=\"token punctuation\">.</span><span class=\"token function\">readFile</span><span class=\"token punctuation\">(</span>logFileName<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n            <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>log<span class=\"token punctuation\">.</span><span class=\"token function\">includes</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"frames successfully decoded\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n              <span class=\"token function\">clearInterval</span><span class=\"token punctuation\">(</span>timer<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>                                      \n              message<span class=\"token punctuation\">.</span>innerHTML <span class=\"token operator\">=</span> <span class=\"token string\">'Finish transcoding'</span><span class=\"token punctuation\">;</span>\n              <span class=\"token keyword\">const</span> out <span class=\"token operator\">=</span> Module<span class=\"token punctuation\">.</span><span class=\"token constant\">FS</span><span class=\"token punctuation\">.</span><span class=\"token function\">readFile</span><span class=\"token punctuation\">(</span><span class=\"token string\">'out.mp4'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n              <span class=\"token keyword\">const</span> video <span class=\"token operator\">=</span> document<span class=\"token punctuation\">.</span><span class=\"token function\">getElementById</span><span class=\"token punctuation\">(</span><span class=\"token string\">'output-video'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n              video<span class=\"token punctuation\">.</span>src <span class=\"token operator\">=</span> <span class=\"token constant\">URL</span><span class=\"token punctuation\">.</span><span class=\"token function\">createObjectURL</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">new</span> <span class=\"token class-name\">Blob</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">[</span>out<span class=\"token punctuation\">.</span>buffer<span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">{</span> <span class=\"token literal-property property\">type</span><span class=\"token operator\">:</span> <span class=\"token string\">'video/mp4'</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n            <span class=\"token punctuation\">}</span>                                                            \n          <span class=\"token punctuation\">}</span> \n        <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span> <span class=\"token number\">500</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>                                                         \n      <span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>  \n      document<span class=\"token punctuation\">.</span><span class=\"token function\">getElementById</span><span class=\"token punctuation\">(</span><span class=\"token string\">'uploader'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">addEventListener</span><span class=\"token punctuation\">(</span><span class=\"token string\">'change'</span><span class=\"token punctuation\">,</span> transcode<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    </span></span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>script</span><span class=\"token punctuation\">></span></span>                                                            \n    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>script</span> <span class=\"token attr-name\">type</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>text/javascript<span class=\"token punctuation\">\"</span></span> <span class=\"token attr-name\">src</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>./dist/ffmpeg-core.js<span class=\"token punctuation\">\"</span></span><span class=\"token punctuation\">></span></span><span class=\"token script\"></span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>script</span><span class=\"token punctuation\">></span></span>\n  <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>body</span><span class=\"token punctuation\">></span></span>                         \n<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>html</span><span class=\"token punctuation\">></span></span></code></pre></div>\n<blockquote>\n<p>It may take a long time to complete, you can open DevTools to see logs. Check <a href=\"https://github.com/ffmpegwasm/FFmpeg/blob/n4.3.1-p4/wasm/transcode.html\">transcode.html</a> to see how it works in action.</p>\n</blockquote>\n<p>You can visit the repository here to see how it works in details: <a href=\"https://github.com/ffmpegwasm/FFmpeg/tree/n4.3.1-p4\">https://github.com/ffmpegwasm/FFmpeg/tree/n4.3.1-p4</a></p>\n<p>And feel free to download the build artifacts here: <a href=\"https://github.com/ffmpegwasm/FFmpeg/releases/tag/n4.3.1-p4\">https://github.com/ffmpegwasm/FFmpeg/releases/tag/n4.3.1-p4</a></p>\n<hr>\n<p>Here is a pause the this series of stories, hope you learnt how to build your own ffmpeg.wasm from scratch and potentially apply to any other libraries. See you next time! ðŸ˜ƒ</p>","frontmatter":{"title":"Build FFmpeg WebAssembly version (= ffmpeg.wasm): Part.4 ffmpeg.wasm v0.2 â€” Add Libx264","date":"October 31, 2019","description":"A series of tutorials of using Emscripten to build ffmpeg"}},"previous":{"fields":{"slug":"/build-ffmpeg-webassembly-version-part-3-v0.1/"},"frontmatter":{"title":"Build FFmpeg WebAssembly version (= ffmpeg.wasm): Part.3 ffmpeg.wasm v0.1 â€” Transcoding avi to mp4"}},"next":{"fields":{"slug":"/speedup-ffmpeg-without-compiling-from-source-code/"},"frontmatter":{"title":"Speedup FFmpeg without compiling from source code"}}},"pageContext":{"id":"fa4d546c-a083-5ebf-8daa-12b9fac68a33","previousPostId":"4372b041-ef89-55ba-96e0-5f919a3b90ff","nextPostId":"a104ab84-f7de-5cdd-86c4-85a4186a18c7"}},"staticQueryHashes":["2841359383","3257411868"]}