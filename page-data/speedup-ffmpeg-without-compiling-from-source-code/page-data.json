{"componentChunkName":"component---src-templates-blog-post-js","path":"/speedup-ffmpeg-without-compiling-from-source-code/","result":{"data":{"site":{"siteMetadata":{"title":"TechBlog"}},"markdownRemark":{"id":"a104ab84-f7de-5cdd-86c4-85a4186a18c7","excerpt":"FFmpeg is a great tool when it comes to multimedia manipulation, by default it uses CPU with multi-thread to do the task which causes a high loading to your PCâ€¦","html":"<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 630px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/33df75f3dd61ce426b147c8ccd6ae14a/eea4a/banner.jpg\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 48.734177215189874%; position: relative; bottom: 0; left: 0; background-image: url('data:image/jpeg;base64,/9j/2wBDABALDA4MChAODQ4SERATGCgaGBYWGDEjJR0oOjM9PDkzODdASFxOQERXRTc4UG1RV19iZ2hnPk1xeXBkeFxlZ2P/2wBDARESEhgVGC8aGi9jQjhCY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2P/wgARCAAKABQDASIAAhEBAxEB/8QAFwABAQEBAAAAAAAAAAAAAAAAAAQDBf/EABQBAQAAAAAAAAAAAAAAAAAAAAH/2gAMAwEAAhADEAAAAehrUCFcX//EABoQAQABBQAAAAAAAAAAAAAAAAECAAMEEyD/2gAIAQEAAQUChdmu5KckOP/EABURAQEAAAAAAAAAAAAAAAAAAAEQ/9oACAEDAQE/ASf/xAAUEQEAAAAAAAAAAAAAAAAAAAAQ/9oACAECAQE/AT//xAAbEAABBAMAAAAAAAAAAAAAAAACAAEDIiAhcf/aAAgBAQAGPwJ68ZWjJbAsP//EABsQAAICAwEAAAAAAAAAAAAAAAERACEgQVFh/9oACAEBAAE/IfHwoW5SsngcLoE8WH//2gAMAwEAAgADAAAAED/P/8QAFhEBAQEAAAAAAAAAAAAAAAAAARAh/9oACAEDAQE/EAhs/8QAFhEBAQEAAAAAAAAAAAAAAAAAARAR/9oACAECAQE/EAyf/8QAGxABAQEBAAMBAAAAAAAAAAAAAREhABAxYXH/2gAIAQEAAT8Q1wxEftCr8OhIpGQssN7IGCo0/d48/wD/2Q=='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"banner\"\n        title=\"banner\"\n        src=\"/static/33df75f3dd61ce426b147c8ccd6ae14a/828fb/banner.jpg\"\n        srcset=\"/static/33df75f3dd61ce426b147c8ccd6ae14a/ff44c/banner.jpg 158w,\n/static/33df75f3dd61ce426b147c8ccd6ae14a/a6688/banner.jpg 315w,\n/static/33df75f3dd61ce426b147c8ccd6ae14a/828fb/banner.jpg 630w,\n/static/33df75f3dd61ce426b147c8ccd6ae14a/0ede0/banner.jpg 945w,\n/static/33df75f3dd61ce426b147c8ccd6ae14a/3ac88/banner.jpg 1260w,\n/static/33df75f3dd61ce426b147c8ccd6ae14a/eea4a/banner.jpg 1280w\"\n        sizes=\"(max-width: 630px) 100vw, 630px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span></p>\n<p>FFmpeg is a great tool when it comes to multimedia manipulation, by default it uses CPU with multi-thread to do the task which causes a high loading to your PC and is kind of slow most of the time.</p>\n<p>If you google how to improve the speed of FFmpeg, you may find discussions about using <code class=\"language-text\">-preset</code> which lowers the compression ratio for higher speed (a trade-off between file size and speed) and another sexy approach is to leverage nVidia GPU (nvenc, nvdec and cuvid), but it it is not easy as:</p>\n<ol>\n<li>You donâ€™t own a compatible nVidia GPU card</li>\n<li>You need to install nVidia GPU drivers and CUDA (painful in Linux environment)</li>\n<li>You need to compile FFmpeg from source if you cannot find a ready-to-use version</li>\n</ol>\n<p>In my own experience, I spent hours to research how to install and compile FFmpeg, but fails in the end as my GPU is unable to support most of the features, that was sad.</p>\n<p>So is there any other way to make FFmpeg faster? Yes, and you can do that within seconds using VAAPI. Letâ€™s do an experiment to see the differences.</p>\n<h2>Baseline: Scale a video without any options</h2>\n<p>Imagine you are creating a service to provide video streaming with different quality (720p, 1080p, etc.), so you need to scale down the uploaded video to different resolution.</p>\n<p>Letâ€™s download a sample video from h264info and scale down without any options:</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">$ ffmpeg -i gravity.mp4 <span class=\"token punctuation\">\\</span>\n    -c:v libx264 <span class=\"token punctuation\">\\</span>\n    -s 1024x428 <span class=\"token punctuation\">\\</span>\n    -b:v 1M <span class=\"token punctuation\">\\</span>\n    out.mp4</code></pre></div>\n<p>It takes about 42 seconds (speed=3.5x) with 21 MB file size. (the original size is 355 MB)</p>\n<h2>With -preset to speedup with larger file size</h2>\n<blockquote>\n<p>Check <a href=\"https://trac.ffmpeg.org/wiki/Encode/H.264\">HERE</a> for more details about preset</p>\n</blockquote>\n<p>Use preset, you can easily speed up FFmpeg with larger file size, which is acceptable when you have enough space left in your hard disk.</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">$ ffmpeg -i gravity.mp4 <span class=\"token punctuation\">\\</span>\n    -c:v libx264 <span class=\"token punctuation\">\\</span>\n    -preset ultrafast <span class=\"token punctuation\">\\</span>\n    -s 1024x428 <span class=\"token punctuation\">\\</span>\n    -b:v 1M <span class=\"token punctuation\">\\</span>\n    out.mp4</code></pre></div>\n<p>It takes about 22 seconds (speed=6x) and with 20 MB file size. (Interesting, it is smaller than <code class=\"language-text\">-preset default</code> ðŸ˜Ž)</p>\n<h2>With VAAPI to speedup with integrated/ Intel GPU card</h2>\n<p>Video Acceleration API (VAAPI) is not a secret in FFmpeg, but it is hard to notice how it can easily help you to speedup FFmpeg. The benefits of using VAAPI are:</p>\n<ol>\n<li>The integrated GPU card is cheap (and you already have one now)</li>\n<li>You only have to install i965-va-driver to make it work</li>\n<li>You donâ€™t have to compile FFmpeg as this flag is enabled by default</li>\n</ol>\n<p>To use VAAPI in Ubuntu, first you need to install driver and check status with vainfo command:</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">$ <span class=\"token function\">sudo</span> <span class=\"token function\">apt-get</span> <span class=\"token function\">install</span> i965-va-driver\n$ vainfo\nlibva info: VA-API version <span class=\"token number\">1.1</span>.0\nlibva info: va_getDriverName<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> returns <span class=\"token number\">0</span>\nlibva info: Trying to <span class=\"token function\">open</span> /usr/lib/x86_64-linux-gnu/dri/i965_drv_video.so\nlibva info: Found init <span class=\"token keyword\">function</span> __vaDriverInit_1_1\nlibva info: va_openDriver<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> returns <span class=\"token number\">0</span>\nvainfo: VA-API version: <span class=\"token number\">1.1</span> <span class=\"token punctuation\">(</span>libva <span class=\"token number\">2.1</span>.0<span class=\"token punctuation\">)</span>\nvainfo: Driver version: Intel i965 driver <span class=\"token keyword\">for</span> Intel<span class=\"token punctuation\">(</span>R<span class=\"token punctuation\">)</span> Ivybridge Mobile - <span class=\"token number\">2.1</span>.0\nvainfo: Supported profile and entrypoints\n      VAProfileMPEG2Simple            <span class=\"token builtin class-name\">:</span> VAEntrypointVLD\n      VAProfileMPEG2Simple            <span class=\"token builtin class-name\">:</span> VAEntrypointEncSlice\n      VAProfileMPEG2Main              <span class=\"token builtin class-name\">:</span> VAEntrypointVLD\n      VAProfileMPEG2Main              <span class=\"token builtin class-name\">:</span> VAEntrypointEncSlice\n      VAProfileH264ConstrainedBaseline: VAEntrypointVLD\n      VAProfileH264ConstrainedBaseline: VAEntrypointEncSlice\n      VAProfileH264Main               <span class=\"token builtin class-name\">:</span> VAEntrypointVLD\n      VAProfileH264Main               <span class=\"token builtin class-name\">:</span> VAEntrypointEncSlice\n      VAProfileH264High               <span class=\"token builtin class-name\">:</span> VAEntrypointVLD\n      VAProfileH264High               <span class=\"token builtin class-name\">:</span> VAEntrypointEncSlice\n      VAProfileH264StereoHigh         <span class=\"token builtin class-name\">:</span> VAEntrypointVLD\n      VAProfileVC1Simple              <span class=\"token builtin class-name\">:</span> VAEntrypointVLD\n      VAProfileVC1Main                <span class=\"token builtin class-name\">:</span> VAEntrypointVLD\n      VAProfileVC1Advanced            <span class=\"token builtin class-name\">:</span> VAEntrypointVLD\n      VAProfileNone                   <span class=\"token builtin class-name\">:</span> VAEntrypointVideoProc\n      VAProfileJPEGBaseline           <span class=\"token builtin class-name\">:</span> VAEntrypointVLD</code></pre></div>\n<p>If you see similar output like above, that means your Intel GPU card supports VAAPI, then you can use following command to scale:</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">$ ffmpeg -hwaccel vaapi <span class=\"token punctuation\">\\</span>\n    -hwaccel_device /dev/dri/renderD129 <span class=\"token punctuation\">\\</span>\n    -hwaccel_output_format vaapi <span class=\"token punctuation\">\\</span>\n    -i gravity.mp4 <span class=\"token punctuation\">\\</span>\n    -vf <span class=\"token string\">\"scale_vaapi=w=1024:h=428\"</span> <span class=\"token punctuation\">\\</span>\n    -c:v h264_vaapi <span class=\"token punctuation\">\\</span>\n    -b:v 1M <span class=\"token punctuation\">\\</span>\n    out.mp4</code></pre></div>\n<p>It takes about 10 seconds (speed=14.3x) and with 19 MB file size.</p>\n<hr>\n<p>Put them altogether in a chart, using VAAPI can get the almost 4x speedup comparing to native and a little smaller file size as well.</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 600px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/1588dfe44a5d662aef1bc8ab19b63ede/0a47e/comparison.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 62.0253164556962%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAMCAIAAADtbgqsAAAACXBIWXMAAAsSAAALEgHS3X78AAABvklEQVQoz42SzysFURTH50+xYMNCLKTHAllIspDslERhYWMpxM6P58fWj9SLslAW6j1LC8qPxfO4L4a8Unj1vLnz676Ze+fOnXFmBj2RnM7UOXPOud/PvR2Jc26aJsZY0zRVVSHOF03LptSGjwlDt0ulkmVRSv0fJrmu6zhO+S+FeFg1VIx13eBvBR0rCsaEECh5ZRYMCyG4w/2wErgf+b9M4twFQIj2z9l4wlZMAcOuCC2SKAt/UaYswJ4/pPWT5KUIFEEzOHc94YbRb/ZxZytUXk7SpjmSNwOeqP8Lzyu/7Wf6bTiepLEZ8yl1LC5PoPqsiPVjgdKvvnwNHdALIPA6Qtc8SqP5AJuFDxZPsdi0gTo6tYEeKJ3escppf2NwhbbV2LIcIbjZTKGlvrS/G+BwHijblEGylGSNU0a2q1sf6oPSxT1rWPATw3GruYrdy3D85ql/sH32VldBdrbCk7gE6qGyWDuiLbMa6unVxvohvXygsUUvMbpK2mvZgwzcrQtsZOKk0FRt7iW8SBmGYXscxhSDZ3PF5xvE8i+QEstBOeX2CuFb5FgWCORedYQe85k0VTGkgCz9vQZ/b8w7qzuPRIOYwWQAAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"comparison\"\n        title=\"comparison\"\n        src=\"/static/1588dfe44a5d662aef1bc8ab19b63ede/0a47e/comparison.png\"\n        srcset=\"/static/1588dfe44a5d662aef1bc8ab19b63ede/c26ae/comparison.png 158w,\n/static/1588dfe44a5d662aef1bc8ab19b63ede/6bdcf/comparison.png 315w,\n/static/1588dfe44a5d662aef1bc8ab19b63ede/0a47e/comparison.png 600w\"\n        sizes=\"(max-width: 600px) 100vw, 600px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span></p>\n<p>In fact, if you invest time and effort to survey the nVidia GPU option you can have even more speedup, but it is still great to have speedups without too much effort and cost, isnâ€™t it? ðŸ˜„</p>\n<p>Hope you find this post useful and donâ€™t hesitate to leave any responses or claps, thank you!</p>","frontmatter":{"title":"Speedup FFmpeg without compiling from source code","date":"November 17, 2019","description":"How to speedup FFmpeg for free"}}},"pageContext":{"slug":"/speedup-ffmpeg-without-compiling-from-source-code/","previous":{"fields":{"slug":"/build-ffmpeg-webassembly-version-part-4-v0.2/"},"frontmatter":{"title":"Build FFmpeg WebAssembly version (= ffmpeg.wasm): Part.4 ffmpeg.wasm v0.2 â€” Add Libx264"}},"next":{"fields":{"slug":"/how-to-speed-up-node-js-modules-installation/"},"frontmatter":{"title":"How to speed up Node.js modules installation in CI/CD pipeline as of 2020"}}}},"staticQueryHashes":["2841359383","916993862"]}