{"componentChunkName":"component---src-templates-blog-post-js","path":"/why-i-refactor-tesseract.js-v2/","result":{"data":{"site":{"siteMetadata":{"title":"TechBlog"}},"markdownRemark":{"id":"462ec7d2-e380-5680-8df3-e4523e795191","excerpt":"After almost 2 years of maintaining tesseract.js, I have to say tesseract.js hit its limitation as some of the issues from users are hard to fix, especially…","html":"<p>After almost 2 years of maintaining tesseract.js, I have to say tesseract.js hit its limitation as some of the issues from users are hard to fix, especially those related to performance.</p>\n<p>The existing tesseract.js (before v2.0.0-alpha) offers declarative and coarse-grained APIs that minimize the effort to understand the complex design of the library, it hides details like how tesseract.js loads *.traineddata from remote, how the *.traineddata is saved to local file system or IndexDB as cache, how the WebAssembly version of tesseract-ocr is initialed with parameters, set the image and generated the result we desired. It is great and everyone is happy to get a turn-key OCR library to integrate into your project.</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token comment\">// Typical usage of tesseract.js</span>\n<span class=\"token keyword\">const</span> <span class=\"token punctuation\">{</span> TesseractWorker <span class=\"token punctuation\">}</span> <span class=\"token operator\">=</span> Tesseract\n<span class=\"token keyword\">const</span> worker <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">TesseractWorker</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n<span class=\"token keyword\">const</span> image <span class=\"token operator\">=</span> <span class=\"token string\">\"https://tesseract.projectnaptha.com/img/eng_bw.png\"</span>\nworker<span class=\"token punctuation\">.</span><span class=\"token function\">recognize</span><span class=\"token punctuation\">(</span>image<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">then</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token parameter\"><span class=\"token punctuation\">{</span> text <span class=\"token punctuation\">}</span></span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n  console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span>text<span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span></code></pre></div>\n<p>But as you use tesseract.js more and more in your project, you figure out the performance is not so good. It feels like every time you call recognize(), tesseract.js always starts from scratch and loads the *.traineddata, initializes its core and set the parameters again and again. It really takes lots of time and the performance becomes unsatisfied.</p>\n<p>Another issue is that every time you want to do something that tesseract-ocr can do with tesseract.js, it fails immediately and you totally don’t know how to solve it, so you create an issue and cross your finger hope someone can save you, but most of the time, the miracle doesn’t happen. So you dive into the source code and find out it is really complicated and twisted inside, in the end you may give up or email the active maintainers of the tesseract.js and wait for the reply.</p>\n<hr>\n<p>So I decided to refactor tesseract.js and after few weeks it is almost done (released as v2.0.0-beta.1) and I would like to share with you the major changes:</p>\n<ol>\n<li>tesseract.js-core (WebAssembly version of tesseract-ocr) is now upgraded using tesseract-ocr v4.1 and emscripten 1.38.45 fastcomp (upstream is not stable enough to compile tesseract-ocr)</li>\n<li>Refactor APIs to be more readable, imperative and fine-grained (we will cover this part later)</li>\n<li>Support scheduling to execute multiple OCR tasks at the same time</li>\n<li>Support typescript with index.d.ts</li>\n<li>Rewrite documents (especially docs/api.md)\nAnd below is how it looks right now:</li>\n</ol>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token comment\">// tesseract.js@^2.0.0-beta.1</span>\n<span class=\"token keyword\">const</span> <span class=\"token punctuation\">{</span> createWorker <span class=\"token punctuation\">}</span> <span class=\"token operator\">=</span> <span class=\"token function\">require</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"tesseract.js\"</span><span class=\"token punctuation\">)</span>\n<span class=\"token keyword\">const</span> image <span class=\"token operator\">=</span> <span class=\"token string\">\"https://tesseract.projectnaptha.com/img/eng_bw.png\"</span>\n<span class=\"token keyword\">const</span> worker <span class=\"token operator\">=</span> <span class=\"token function\">createWorker</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">;</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">async</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">await</span> worker<span class=\"token punctuation\">.</span><span class=\"token function\">load</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n  <span class=\"token keyword\">await</span> worker<span class=\"token punctuation\">.</span><span class=\"token function\">loadLanguage</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"eng\"</span><span class=\"token punctuation\">)</span>\n  <span class=\"token keyword\">await</span> worker<span class=\"token punctuation\">.</span><span class=\"token function\">initialize</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"eng\"</span><span class=\"token punctuation\">)</span>\n  <span class=\"token keyword\">const</span> <span class=\"token punctuation\">{</span>\n    data<span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span> text <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n  <span class=\"token punctuation\">}</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">await</span> worker<span class=\"token punctuation\">.</span><span class=\"token function\">recognize</span><span class=\"token punctuation\">(</span>image<span class=\"token punctuation\">)</span>\n  console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span>text<span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></code></pre></div>\n<p>It may feel kind of weird to see that you need to do more things in the new version, but with more lines of code you have more in-depth control of tesseract.js and boost the performance of your project. A possible use case is like this:</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token keyword\">const</span> <span class=\"token punctuation\">{</span> createWorker <span class=\"token punctuation\">}</span> <span class=\"token operator\">=</span> <span class=\"token function\">require</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"tesseract.js\"</span><span class=\"token punctuation\">)</span>\n<span class=\"token keyword\">const</span> image <span class=\"token operator\">=</span> <span class=\"token string\">\"https://tesseract.projectnaptha.com/img/eng_bw.png\"</span>\n<span class=\"token keyword\">const</span> worker <span class=\"token operator\">=</span> <span class=\"token function\">createWorker</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n<span class=\"token keyword\">let</span> isReady <span class=\"token operator\">=</span> <span class=\"token boolean\">false</span>\n<span class=\"token comment\">// Called as early as possible</span>\n<span class=\"token punctuation\">;</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">async</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">await</span> worker<span class=\"token punctuation\">.</span><span class=\"token function\">load</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n  <span class=\"token keyword\">await</span> worker<span class=\"token punctuation\">.</span><span class=\"token function\">loadLanguage</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"eng\"</span><span class=\"token punctuation\">)</span>\n  <span class=\"token keyword\">await</span> worker<span class=\"token punctuation\">.</span><span class=\"token function\">initialize</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"eng\"</span><span class=\"token punctuation\">)</span>\n  isReady <span class=\"token operator\">=</span> <span class=\"token boolean\">true</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n<span class=\"token comment\">// Do other stuffs</span>\n<span class=\"token punctuation\">;</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">async</span> <span class=\"token parameter\">img</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>isReady<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">const</span> <span class=\"token punctuation\">{</span>\n      data<span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span> text <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n    <span class=\"token punctuation\">}</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">await</span> worker<span class=\"token punctuation\">.</span><span class=\"token function\">recognize</span><span class=\"token punctuation\">(</span>img<span class=\"token punctuation\">)</span>\n    console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span>text<span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">(</span>image<span class=\"token punctuation\">)</span></code></pre></div>\n<p>The benefit is that you can prepare the worker as early as possible to improve the overall user experience.</p>\n<p>Another important feature is that we add scheduling capabilities for you to use multiple workers at the same time. It is useful when you have enough resource (CPU cores) for your project to decrease the time for massive recognition jobs.</p>\n<p>Below is a sample code for using scheduler with 4 workers to handle 10 recognition jobs:</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token keyword\">const</span> <span class=\"token punctuation\">{</span> createWorker<span class=\"token punctuation\">,</span> createScheduler <span class=\"token punctuation\">}</span> <span class=\"token operator\">=</span> <span class=\"token function\">require</span><span class=\"token punctuation\">(</span><span class=\"token string\">'tesseract.js'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">const</span> image <span class=\"token operator\">=</span> <span class=\"token string\">'https://tesseract.projectnaptha.com/img/eng_bw.png'</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">const</span> scheduler <span class=\"token operator\">=</span> <span class=\"token function\">createScheduler</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token punctuation\">(</span><span class=\"token keyword\">async</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">let</span> i <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span> i <span class=\"token operator\">&lt;</span> <span class=\"token number\">4</span><span class=\"token punctuation\">;</span> i<span class=\"token operator\">++</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">const</span> w <span class=\"token operator\">=</span> <span class=\"token function\">createWorker</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">await</span> w<span class=\"token punctuation\">.</span><span class=\"token function\">load</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">await</span> w<span class=\"token punctuation\">.</span><span class=\"token function\">loadLanguage</span><span class=\"token punctuation\">(</span><span class=\"token string\">'eng'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">await</span> w<span class=\"token punctuation\">.</span><span class=\"token function\">initialize</span><span class=\"token punctuation\">(</span><span class=\"token string\">'eng'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    scheduler<span class=\"token punctuation\">.</span><span class=\"token function\">addWorker</span><span class=\"token punctuation\">(</span>w<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n  <span class=\"token keyword\">const</span> rets <span class=\"token operator\">=</span> <span class=\"token keyword\">await</span> Promise<span class=\"token punctuation\">.</span><span class=\"token function\">all</span><span class=\"token punctuation\">(</span><span class=\"token function\">Array</span><span class=\"token punctuation\">(</span><span class=\"token number\">10</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">fill</span><span class=\"token punctuation\">(</span><span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">map</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">(</span>\n    scheduler<span class=\"token punctuation\">.</span><span class=\"token function\">addJob</span><span class=\"token punctuation\">(</span><span class=\"token string\">'recognize'</span><span class=\"token punctuation\">,</span> image<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span>rets<span class=\"token punctuation\">.</span><span class=\"token function\">map</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token parameter\"><span class=\"token punctuation\">{</span> data<span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span> text <span class=\"token punctuation\">}</span> <span class=\"token punctuation\">}</span></span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> text<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">await</span> scheduler<span class=\"token punctuation\">.</span><span class=\"token function\">terminate</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>The role of scheduler is to manage the job queue and worker pool and distribute jobs any idle workers.</p>\n<p>A performance comparison between alpha version and beta version can be found below (using Node version in a 8 core machine).</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 600px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/676838fb00bebc7e57f5dd43d5b31284/0a47e/performance.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 62.0253164556962%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAMCAIAAADtbgqsAAAACXBIWXMAAAsSAAALEgHS3X78AAABmUlEQVQoz41SSU/CUBDm93gwXhRcEvXkD3KJHmwFUQhuMSb+Aj0YNSxuGA968+JZ4447YC2l89q3dMF50IMYUSdf25m8+eb7pm3IdV1N00qlEgBUq1Vd1/HeyIFYJlgfuvGufRiGwRirNUcIL9/3hRC1f4T/JQKy53lCOJhsnPKRdTq8RtNnctbxubN6xBEnF06D+IMyOqdUWlI2accEtI+byZws1S3aNmq2jZnRbYpk1/O/KxNC0LNwpPJMhvVFSY8KSwccy9QOloCY35WzvO/CtVC5XLZtu2E7nqY9UySiwMK+7E5kWbdKEDgFlT3JDhAo48KuG+wczzAkhxVY3JfKaD6iQrcKdXKNcp8w32I+d5p29iiT3dNpGlGtzkkyvye7Z7OsS7HCipWov4LlPBtKEsTKIW8YCT6V47j4TOXswVilP6qv5O16CQOxCmIuB1gms9CnVnrVSioLTWTOuRDcMOnl7fPV3UsVqCPEw3Px+v7tplDEBE8LT2+3D8Xrwuv94yv2o9/Q738FAdMiZqvTP8hePVqdfgI3voRnaYyiLAAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"Tesseract.js v2 performance\"\n        title=\"Tesseract.js v2 performance\"\n        src=\"/static/676838fb00bebc7e57f5dd43d5b31284/0a47e/performance.png\"\n        srcset=\"/static/676838fb00bebc7e57f5dd43d5b31284/c26ae/performance.png 158w,\n/static/676838fb00bebc7e57f5dd43d5b31284/6bdcf/performance.png 315w,\n/static/676838fb00bebc7e57f5dd43d5b31284/0a47e/performance.png 600w\"\n        sizes=\"(max-width: 600px) 100vw, 600px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span></p>\n<p>Source code: <a href=\"https://github.com/jeromewu/tesseract.js-performance\">https://github.com/jeromewu/tesseract.js-performance</a></p>\n<p>With 4 workers we can have a almost 3x speed up (from 60s to 20s), it is possible to speed up with even more workers!</p>\n<p>If you are interested in using tesseract and giving feedback, please visit <a href=\"https://github.com/naptha/tesseract.js\">tesseract.js github</a> and try it with following command:</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">$ npm install tesseract.js@next</code></pre></div>\n<p>Hope you enjoy tesseract.js and thanks for reading this post. :)</p>","frontmatter":{"title":"Why I refactor tesseract.js v2?","date":"October 03, 2019","description":"The story behind tesseract.js v2 refactoring."}}},"pageContext":{"slug":"/why-i-refactor-tesseract.js-v2/","previous":null,"next":null}},"staticQueryHashes":["2841359383","916993862"]}