{"componentChunkName":"component---src-templates-blog-post-js","path":"/build-ffmpeg-webassembly-version-part-2-compile-with-emscripten/","result":{"data":{"site":{"siteMetadata":{"title":"TechBlog"}},"markdownRemark":{"id":"e7b0e078-202f-52b5-9e84-2a39e2b3441f","excerpt":"From here, things are going to be more complicated and hard to understand, you may need to google background knowledge if you don’t know what happened (or you…","html":"<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 630px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/899a0ba50105cb44cf23fe8cc40b8e42/6af66/ffmpeg-wasm-cover.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 56.32911392405063%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAALCAIAAADwazoUAAAACXBIWXMAAAsSAAALEgHS3X78AAABcklEQVQoz4WQUUvCUBiG+zPddRN0223/IxSDhr/AiDJkYxcGIQoiSYK7i8zE8q4N3AJRGzKtG3WDhZZkbrLtbG7rbBOtkflwLs75zvt+7znfhm3blu0AZuD4Ft083Y5UTko3d6GDUDabpWm6Xq9zHFer1ViWFUXR0Vuew95wzc5BBvLuxd4WvrN/fVgu3cfP44VCIRqNIggSDoeDwWAgEEin01BpGMbS7KHNQFNkq32m2C4DHRgusM7zvCAIcAPDW62WP/lPoMI0TQCAvZqfZtOyZqazTK/3dDolCEJV1fm1aS4y1yR74bIsr0+GTXuD4qt4OfxqwKOqKpqmwShd1xVF4QUedplMJpqL36wb+nMfe+oivY9i5YGMxc4wDEumkslUKk/kM5lM5CiC43gikUBRVJIk711zs2HowxH/9t4djQcc1yYpqgqhHTovnUeSvMrlGs0mRVEMw8C3/Ep2vyd9jkeqpqya/P/TXkp9+OoL5TdLEVHIfhB1uAAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"ffmpeg wasm cover\"\n        title=\"ffmpeg wasm cover\"\n        src=\"/static/899a0ba50105cb44cf23fe8cc40b8e42/f058b/ffmpeg-wasm-cover.png\"\n        srcset=\"/static/899a0ba50105cb44cf23fe8cc40b8e42/c26ae/ffmpeg-wasm-cover.png 158w,\n/static/899a0ba50105cb44cf23fe8cc40b8e42/6bdcf/ffmpeg-wasm-cover.png 315w,\n/static/899a0ba50105cb44cf23fe8cc40b8e42/f058b/ffmpeg-wasm-cover.png 630w,\n/static/899a0ba50105cb44cf23fe8cc40b8e42/6af66/ffmpeg-wasm-cover.png 640w\"\n        sizes=\"(max-width: 630px) 100vw, 630px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span></p>\n<blockquote>\n<p>From here, things are going to be more complicated and hard to understand, you may need to google background knowledge if you don’t know what happened (or you can leave responses to ask me).\nAlso, to make this tutorial more usable, I try to write down the details of how I solved each issue, hope it will help you in building the library of your choice.</p>\n</blockquote>\n<p>In this part you will learn:</p>\n<ol>\n<li>How to setup environment of Emscripten using Docker</li>\n<li>Usage of emconfigure and emmake</li>\n<li>How to fix issues when compiling FFmpeg with Emscripten</li>\n</ol>\n<hr>\n<p>How to setup environment of Emscripten using Docker\nIn Build FFmpeg WebAssembly version (= ffmpeg.wasm): Part.1 Preparation, we have built the original version of FFmpeg with GCC, and now we move on to use Emscripten instead.</p>\n<p>The version of Emscripten we are going to use is 1.39.18 (trzeci/emscripten:1.39.18-upstream), you can install the Emscripten through the official tutorial (in this tutorial, we are setup-emsdk Github Actions in MacOS) or pull Emscripten image from docker hub.</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">$ <span class=\"token function\">docker</span> pull trzeci/emscripten:1.39.18-upstream</code></pre></div>\n<blockquote>\n<p>It may take few minutes as the size of the image is around 1 GB.</p>\n</blockquote>\n<p>Then we need to update <code class=\"language-text\">build-with-docker.sh</code> like below:</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token shebang important\">#!/bin/bash -x</span>\n\n<span class=\"token assign-left variable\">EM_VERSION</span><span class=\"token operator\">=</span><span class=\"token number\">1.39</span>.18-upstream\n\n<span class=\"token function\">docker</span> pull trzeci/emscripten:<span class=\"token variable\">$EM_VERSION</span>\n<span class=\"token function\">docker</span> run <span class=\"token punctuation\">\\</span>\n  -v <span class=\"token environment constant\">$PWD</span>:/src <span class=\"token punctuation\">\\</span>\n  -v <span class=\"token environment constant\">$PWD</span>/cache-wasm:/emsdk_portable/.data/cache/wasm <span class=\"token punctuation\">\\</span>\n  trzeci/emscripten:<span class=\"token variable\">$EM_VERSION</span> <span class=\"token punctuation\">\\</span>\n  <span class=\"token function\">sh</span> -c <span class=\"token string\">'bash ./build.sh'</span></code></pre></div>\n<blockquote>\n<p>cache-wasm is not required, but it can help you to speed up in subsequent build.</p>\n</blockquote>\n<p>The next we are going to do is to find the configuration to build FFmpeg with emscripten, it is a try-and-error process and requires document digging and patient.</p>\n<h2>Usage of <code class=\"language-text\">emconfigure</code> and <code class=\"language-text\">emmake</code> &#x26; How to fix issues when compiling FFmpeg with Emscripten</h2>\n<p>Let’s start our journey of finding the right configuration. In Part.1, it starts with <code class=\"language-text\">./configure --disable-x86asm</code>, to do it with emscripten, you need to change it to <code class=\"language-text\">emconfigure ./configure --disable-x86asm</code>. (For details of emconfigure, please check <a href=\"https://emscripten.org/docs/compiling/Building-Projects.html#integrating-with-a-build-system\">HERE</a>) And as we are doing cross compiling, we need to add cross-compiling flags to explicitly tell FFmpeg.</p>\n<p>Let’s update <code class=\"language-text\">build.sh</code> like below:</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token shebang important\">#!/bin/bash -x</span>\n\n<span class=\"token comment\"># verify Emscripten version</span>\nemcc -v\n\n<span class=\"token comment\"># configure FFMpeg with Emscripten</span>\n<span class=\"token assign-left variable\">ARGS</span><span class=\"token operator\">=</span><span class=\"token punctuation\">(</span>\n  --target-os<span class=\"token operator\">=</span>none        <span class=\"token comment\"># use none to prevent any os specific configurations</span>\n  --arch<span class=\"token operator\">=</span>x86_32           <span class=\"token comment\"># use x86_32 to achieve minimal architectural optimization</span>\n  --enable-cross-compile  <span class=\"token comment\"># enable cross compile</span>\n  --disable-x86asm        <span class=\"token comment\"># disable x86 asm</span>\n<span class=\"token punctuation\">)</span>\nemconfigure ./configure <span class=\"token string\">\"<span class=\"token variable\">${ARGS<span class=\"token punctuation\">[</span>@<span class=\"token punctuation\">]</span>}</span>\"</span></code></pre></div>\n<p>And magically there is no error or anything wrong, so do we just need to type <code class=\"language-text\">emmake make -j</code> and we get FFmpeg.wasm? Unfortunately, the answer is no. One of the most important task for <code class=\"language-text\">emconfigure</code> is to replace the compiler from gcc to emcc (or g++ to em++), but in the output of <code class=\"language-text\">./configure</code>, we still get gcc as our compiler.</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">emscripten sdl2-config called with /emsdk_portable/emscripten/tag-1.38.45/system/bin/sdl2-config --cflags                            \nemscripten sdl2-config called with /emsdk_portable/emscripten/tag-1.38.45/system/bin/sdl2-config --libs                               \ninstall prefix            /usr/local                                                                                                   \nsource path               .                                                                                                                \nC compiler                gcc             # Should be emcc                                                                                             \nC library                 glibc                                                                                                           \nARCH                      x86 (generic)                                                                                                     \nbig-endian                no                                                                                                            \nruntime cpu detection     yes                                                                                                         \nstandalone assembly       no                                                                                                            \nx86 assembler             nasm</code></pre></div>\n<p>Every automation tool has its limitation and we need to do it manually in this case. Let’s check if there is any arguments to save us.</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">$ ./configure --help</code></pre></div>\n<p>Under <code class=\"language-text\">Toolchain options</code>, there are arguments to assign the compiler to use.</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">root@57ab95def750:/src# ./configure --help\nUsage: configure [options]\nOptions: [defaults in brackets after descriptions]\nHelp options:\n...\nToolchain options:                                                                                                             \n...\n  --nm=NM                  use nm tool NM [nm -g]\n  --ar=AR                  use archive tool AR [ar]\n  --as=AS                  use assembler AS []\n  --ln_s=LN_S              use symbolic link tool LN_S [ln -s -f]\n  --strip=STRIP            use strip tool STRIP [strip]\n  --windres=WINDRES        use windows resource compiler WINDRES [windres]\n  --x86asmexe=EXE          use nasm-compatible assembler EXE [nasm]\n  --cc=CC                  use C compiler CC [gcc]\n  --cxx=CXX                use C compiler CXX [g++]\n  --objcc=OCC              use ObjC compiler OCC [gcc]\n  --dep-cc=DEPCC           use dependency generator DEPCC [gcc]\n  --nvcc=NVCC              use Nvidia CUDA compiler NVCC [nvcc]\n  --ld=LD                  use linker LD []\n…..</code></pre></div>\n<p>Let’s pass these arguments to compile with emscripten in <code class=\"language-text\">build.sh</code> :</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token shebang important\">#!/bin/bash -x</span>\n\n<span class=\"token comment\"># verify Emscripten version</span>\nemcc -v\n\n<span class=\"token comment\"># configure FFMpeg with Emscripten</span>\n<span class=\"token assign-left variable\">FLAGS</span><span class=\"token operator\">=</span><span class=\"token punctuation\">(</span>\n  --target-os<span class=\"token operator\">=</span>none        <span class=\"token comment\"># use none to prevent any os specific configurations</span>\n  --arch<span class=\"token operator\">=</span>x86_32           <span class=\"token comment\"># use x86_32 to achieve minimal architectural optimization</span>\n  --enable-cross-compile  <span class=\"token comment\"># enable cross compile</span>\n  --disable-x86asm        <span class=\"token comment\"># disable x86 asm</span>\n  --nm<span class=\"token operator\">=</span><span class=\"token string\">\"llvm-nm -g\"</span>\n  --ar<span class=\"token operator\">=</span>emar\n  --as<span class=\"token operator\">=</span>llvm-as\n  --ranlib<span class=\"token operator\">=</span>llvm-ranlib\n  --cc<span class=\"token operator\">=</span>emcc\n  --cxx<span class=\"token operator\">=</span>em++\n  --objcc<span class=\"token operator\">=</span>emcc\n  --dep-cc<span class=\"token operator\">=</span>emcc\n<span class=\"token punctuation\">)</span>\nemconfigure ./configure <span class=\"token string\">\"<span class=\"token variable\">${FLAGS<span class=\"token punctuation\">[</span>@<span class=\"token punctuation\">]</span>}</span>\"</span></code></pre></div>\n<blockquote>\n<p>For native build, please make sure <code class=\"language-text\">llvm-ranlib</code>, <code class=\"language-text\">llvm-as</code> and <code class=\"language-text\">llvm-nm</code> exist. If not, you can find them in <code class=\"language-text\">$EMSDK_ROOT/upstream/bin</code> .</p>\n</blockquote>\n<p>With these arguments the <code class=\"language-text\">./configure</code> will take more time to run, but you will get desired output in the end.</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">emscripten sdl2-config called with /emsdk_portable/emscripten/tag-1.39.18/system/bin/sdl2-config --cflags                            \nemscripten sdl2-config called with /emsdk_portable/emscripten/tag-1.39.18/system/bin/sdl2-config --libs                                     \ninstall prefix            /usr/local                                                                                                   \nsource path               .                                                                                                         \nC compiler                emcc         # emcc as expected                                                                                    \nC library                                                                                                                          \nARCH                      x86 (generic)                                                                                                     \nbig-endian                no                                                                                                              \nruntime cpu detection     yes                                                                                                             \nstandalone assembly       no</code></pre></div>\n<p>Add <code class=\"language-text\">emmake make -j4</code> (You can raise the parallelism to like <code class=\"language-text\">-j8</code> or simply use <code class=\"language-text\">-j</code> to use all cores) in the end of <code class=\"language-text\">build.sh</code> :</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token shebang important\">#!/bin/bash -x</span>\n\n<span class=\"token comment\"># verify Emscripten version</span>\nemcc -v\n\n<span class=\"token comment\"># configure FFMpeg with Emscripten</span>\n<span class=\"token assign-left variable\">ARGS</span><span class=\"token operator\">=</span><span class=\"token punctuation\">(</span>\n  --target-os<span class=\"token operator\">=</span>none        <span class=\"token comment\"># use none to prevent any os specific configurations</span>\n  --arch<span class=\"token operator\">=</span>x86_32           <span class=\"token comment\"># use x86_32 to achieve minimal architectural optimization</span>\n  --enable-cross-compile  <span class=\"token comment\"># enable cross compile</span>\n  --disable-x86asm        <span class=\"token comment\"># disable x86 asm</span>\n  --nm<span class=\"token operator\">=</span><span class=\"token string\">\"llvm-nm -g\"</span>\n  --ar<span class=\"token operator\">=</span>emar\n  --as<span class=\"token operator\">=</span>llvm-as\n  --ranlib<span class=\"token operator\">=</span>llvm-ranlib\n  --cc<span class=\"token operator\">=</span>emcc\n  --cxx<span class=\"token operator\">=</span>em++\n  --objcc<span class=\"token operator\">=</span>emcc\n  --dep-cc<span class=\"token operator\">=</span>emcc\n<span class=\"token punctuation\">)</span>\nemconfigure ./configure <span class=\"token string\">\"<span class=\"token variable\">${ARGS<span class=\"token punctuation\">[</span>@<span class=\"token punctuation\">]</span>}</span>\"</span>\n\n<span class=\"token comment\"># build ffmpeg.wasm</span>\nemmake <span class=\"token function\">make</span> -j4</code></pre></div>\n<p>And it fails immediately after execution:</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">...\n./libavutil/x86/timer.h:39:24: error: invalid output constraint '=a' in asm\n                     : \"=a\" (a), \"=d\" (d));\n                       ^</code></pre></div>\n<p>From the output message, we can identify that the error is related to asm. Open <code class=\"language-text\">./libavutil/x86/timer.h</code> and we can confirm the issue is caused by the x86 inline assembly, which is not compatible with WebAssembly, so the solution is to disable it in <code class=\"language-text\">build.sh</code>:</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token shebang important\">#!/bin/bash -x</span>\n\n<span class=\"token comment\"># verify Emscripten version</span>\nemcc -v\n\n<span class=\"token comment\"># configure FFMpeg with Emscripten</span>\n<span class=\"token assign-left variable\">ARGS</span><span class=\"token operator\">=</span><span class=\"token punctuation\">(</span>\n  --target-os<span class=\"token operator\">=</span>none        <span class=\"token comment\"># use none to prevent any os specific configurations</span>\n  --arch<span class=\"token operator\">=</span>x86_32           <span class=\"token comment\"># use x86_32 to achieve minimal architectural optimization</span>\n  --enable-cross-compile  <span class=\"token comment\"># enable cross compile</span>\n  --disable-x86asm        <span class=\"token comment\"># disable x86 asm</span>\n  --disable-inline-asm    <span class=\"token comment\"># disable inline asm</span>\n  --nm<span class=\"token operator\">=</span><span class=\"token string\">\"llvm-nm -g\"</span>\n  --ar<span class=\"token operator\">=</span>emar\n  --as<span class=\"token operator\">=</span>llvm-as\n  --ranlib<span class=\"token operator\">=</span>llvm-ranlib\n  --cc<span class=\"token operator\">=</span>emcc\n  --cxx<span class=\"token operator\">=</span>em++\n  --objcc<span class=\"token operator\">=</span>emcc\n  --dep-cc<span class=\"token operator\">=</span>emcc\n<span class=\"token punctuation\">)</span>\nemconfigure ./configure <span class=\"token string\">\"<span class=\"token variable\">${ARGS<span class=\"token punctuation\">[</span>@<span class=\"token punctuation\">]</span>}</span>\"</span>\n\n<span class=\"token comment\"># build ffmpeg.wasm</span>\nemmake <span class=\"token function\">make</span> -j4</code></pre></div>\n<p>It works and keeps compiling until we hit another error:</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">...\nCC libavfilter/dnn/dnn_backend_native_layers.o\nIn file included from libavfilter/aeval.c:26:\nIn file included from ./libavutil/avassert.h:31:\nIn file included from ./libavutil/avutil.h:296:\nIn file included from ./libavutil/common.h:533:\nIn file included from ./libavutil/internal.h:176:\n./libavutil/libm.h:54:32: error: static declaration of 'cbrt' follows non-static declaration\nstatic av_always_inline double cbrt(double x)\n                               ^\n/emsdk_portable/upstream/emscripten/system/include/libc/math.h:151:13: note: previous declaration is here\ndouble      cbrt(double);\n            ^\nIn file included from libavfilter/aeval.c:26:</code></pre></div>\n<p>This time the root cause is not so obvious, so we need to dig deeper inside what went wrong during the <code class=\"language-text\">./configure</code>. A very helpful file to check is <code class=\"language-text\">ffbuild/config.log</code>, it contains logs during <code class=\"language-text\">./configure</code> and most of time you can find the root cause there.</p>\n<p>By search <code class=\"language-text\">cbrt</code> inside <code class=\"language-text\">config.log</code>, we find error message below:</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">...\ncheck_mathfunc cbrt 1                                                         \ntest_ld cc                                                                     \ntest_cc                                                                       \nBEGIN /tmp/ffconf.syfN4Irw/test.c                                             \n1 #include &lt;math.h>                                                           \n2 float foo(float f, float g) { return cbrt(f); }         \n    3 int main(void){ return (int) foo; }                                     \nEND /tmp/ffconf.syfN4Irw/test.c                                               \nemcc -D_ISOC99_SOURCE -D_FILE_OFFSET_BITS=64 -D_LARGEFILE_SOURCE -D_POSIX_C_SOURCE=200112 -D_XOPEN_SOURCE=600 -std=c11 -fomit-frame-pointer -pthread -c -o /tmp/ffconf.syfN4Irw/test.o /tmp/ffconf.syfN4Irw/test.c         \nemcc -Wl,-z,noexecstack -o /tmp/ffconf.syfN4Irw/test /tmp/ffconf.syfN4Irw/test.o\nwasm-ld: error: 'atomics' feature is used by /tmp/ffconf.syfN4Irw/test.o, so --shared-memory must be used\n...                    </code></pre></div>\n<p>This test tried to check if cbrt works in the environment, but it fails due to <code class=\"language-text\">atomics</code> feature errored. <code class=\"language-text\">atomics</code> is asked when you are using pthread, so let’s add <code class=\"language-text\">pthread</code> flags. (Check <a href=\"https://emscripten.org/docs/porting/pthreads.html\">HERE</a> for more details about pthread flags)</p>\n<p>Update <code class=\"language-text\">build.sh</code>:</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token shebang important\">#!/bin/bash -x</span>\n\n<span class=\"token comment\"># verify Emscripten version</span>\nemcc -v\n\n<span class=\"token comment\"># configure FFMpeg with Emscripten</span>\n<span class=\"token assign-left variable\">CFLAGS</span><span class=\"token operator\">=</span><span class=\"token string\">\"-s USE_PTHREADS\"</span>\n<span class=\"token assign-left variable\">LDFLAGS</span><span class=\"token operator\">=</span><span class=\"token string\">\"<span class=\"token variable\">$CFLAGS</span>\"</span>\n<span class=\"token assign-left variable\">ARGS</span><span class=\"token operator\">=</span><span class=\"token punctuation\">(</span>\n  --target-os<span class=\"token operator\">=</span>none        <span class=\"token comment\"># use none to prevent any os specific configurations</span>\n  --arch<span class=\"token operator\">=</span>x86_32           <span class=\"token comment\"># use x86_32 to achieve minimal architectural optimization</span>\n  --enable-cross-compile  <span class=\"token comment\"># enable cross compile</span>\n  --disable-x86asm        <span class=\"token comment\"># disable x86 asm</span>\n  --disable-inline-asm    <span class=\"token comment\"># disable inline asm</span>\n  --extra-cflags<span class=\"token operator\">=</span><span class=\"token string\">\"<span class=\"token variable\">$CFLAGS</span>\"</span>\n  --extra-cxxflags<span class=\"token operator\">=</span><span class=\"token string\">\"<span class=\"token variable\">$CFLAGS</span>\"</span>\n  --extra-ldflags<span class=\"token operator\">=</span><span class=\"token string\">\"<span class=\"token variable\">$LDFLAGS</span>\"</span>\n  --nm<span class=\"token operator\">=</span><span class=\"token string\">\"llvm-nm -g\"</span>\n  --ar<span class=\"token operator\">=</span>emar\n  --as<span class=\"token operator\">=</span>llvm-as\n  --ranlib<span class=\"token operator\">=</span>llvm-ranlib\n  --cc<span class=\"token operator\">=</span>emcc\n  --cxx<span class=\"token operator\">=</span>em++\n  --objcc<span class=\"token operator\">=</span>emcc\n  --dep-cc<span class=\"token operator\">=</span>emcc\n<span class=\"token punctuation\">)</span>\nemconfigure ./configure <span class=\"token string\">\"<span class=\"token variable\">${ARGS<span class=\"token punctuation\">[</span>@<span class=\"token punctuation\">]</span>}</span>\"</span>\n\n<span class=\"token comment\"># build ffmpeg.wasm</span>\nemmake <span class=\"token function\">make</span> -j4</code></pre></div>\n<p>It works and keeps compiling until we hit another error:</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">...\nLD      ffplay_g                                                                                                                                  emcc: warning: ignoring unsupported linker flag: `-rpath-link=:libpostproc:libswresample:libswscale:libavfilter:libavdevice:libavformat:libavcodec:libavutil:libavresample` [-Wlinkflags]                                                                                                           \n7 warnings generated.                                                      \nwasm-ld: error: initial memory too small, 19491744 bytes needed\n...                    \nmake: *** [Makefile:114: ffplay_g] Error 1\nmake: *** Waiting for unfinished jobs....\nemcc: warning: ignoring unsupported linker flag: `-rpath-link=:libpostproc:libswresample:libswscale:libavfilter:libavdevice:libavformat:libavcodec\n:libavutil:libavresample` [-Wlinkflags]\n...</code></pre></div>\n<p>This time the issue is caused by too small in initial memory (by default only 16 MB in Emscripten, and here the minimal is 19+ MB), so we need to raise the initial memory to a higher value by passing <code class=\"language-text\">-s INITIAL_MEMORY=33554432</code> (32 MB).</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token shebang important\">#!/bin/bash -x</span>\n\n<span class=\"token comment\"># verify Emscripten version</span>\nemcc -v\n\n<span class=\"token comment\"># configure FFMpeg with Emscripten</span>\n<span class=\"token assign-left variable\">CFLAGS</span><span class=\"token operator\">=</span><span class=\"token string\">\"-s USE_PTHREADS\"</span>\n<span class=\"token assign-left variable\">LDFLAGS</span><span class=\"token operator\">=</span><span class=\"token string\">\"<span class=\"token variable\">$CFLAGS</span> -s INITIAL_MEMORY=33554432\"</span> <span class=\"token comment\"># 33554432 bytes = 32 MB</span>\n<span class=\"token assign-left variable\">ARGS</span><span class=\"token operator\">=</span><span class=\"token punctuation\">(</span>\n  --target-os<span class=\"token operator\">=</span>none        <span class=\"token comment\"># use none to prevent any os specific configurations</span>\n  --arch<span class=\"token operator\">=</span>x86_32           <span class=\"token comment\"># use x86_32 to achieve minimal architectural optimization</span>\n  --enable-cross-compile  <span class=\"token comment\"># enable cross compile</span>\n  --disable-x86asm        <span class=\"token comment\"># disable x86 asm</span>\n  --disable-inline-asm    <span class=\"token comment\"># disable inline asm</span>\n  --extra-cflags<span class=\"token operator\">=</span><span class=\"token string\">\"<span class=\"token variable\">$CFLAGS</span>\"</span>\n  --extra-cxxflags<span class=\"token operator\">=</span><span class=\"token string\">\"<span class=\"token variable\">$CFLAGS</span>\"</span>\n  --extra-ldflags<span class=\"token operator\">=</span><span class=\"token string\">\"<span class=\"token variable\">$LDFLAGS</span>\"</span>\n  --nm<span class=\"token operator\">=</span><span class=\"token string\">\"llvm-nm -g\"</span>\n  --ar<span class=\"token operator\">=</span>emar\n  --as<span class=\"token operator\">=</span>llvm-as\n  --ranlib<span class=\"token operator\">=</span>llvm-ranlib\n  --cc<span class=\"token operator\">=</span>emcc\n  --cxx<span class=\"token operator\">=</span>em++\n  --objcc<span class=\"token operator\">=</span>emcc\n  --dep-cc<span class=\"token operator\">=</span>emcc\n<span class=\"token punctuation\">)</span>\n\nemconfigure ./configure <span class=\"token string\">\"<span class=\"token variable\">${ARGS<span class=\"token punctuation\">[</span>@<span class=\"token punctuation\">]</span>}</span>\"</span>\n\n<span class=\"token comment\"># build ffmpeg.wasm</span>\nemmake <span class=\"token function\">make</span> -j4</code></pre></div>\n<p>Still there is an error after this fix:</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">LD      ffplay_g\nemcc: warning: ignoring unsupported linker flag: `-rpath-link=:libpostproc:libswresample:libswscale:libavfilter:libavdevice:libavformat:libavcodec:libavutil:libavresample` [-Wlinkflags]\n6 warnings generated.\nLD      ffmpeg_g\nemcc: warning: ignoring unsupported linker flag: `-rpath-link=:libpostproc:libswresample:libswscale:libavfilter:libavdevice:libavformat:libavcodec:libavutil:libavresample` [-Wlinkflags]\n9 warnings generated.\nLD      ffprobe_g\nemcc: warning: ignoring unsupported linker flag: `-rpath-link=:libpostproc:libswresample:libswscale:libavfilter:libavdevice:libavformat:libavcodec:libavutil:libavresample` [-Wlinkflags]\nSTRIP   ffmpeg\nstrip:ffmpeg_g: file format not recognized\nmake: *** [Makefile:107: ffmpeg] Error 1\nmake: *** Waiting for unfinished jobs....</code></pre></div>\n<p>As we are unable to strip (make sense as it is not in a valid binary format), let’s simply disable strip with <code class=\"language-text\">--disable-stripping</code> and make again:</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token shebang important\">#!/bin/bash -x</span>\n\n<span class=\"token comment\"># verify Emscripten version</span>\nemcc -v\n\n<span class=\"token comment\"># configure FFMpeg with Emscripten</span>\n<span class=\"token assign-left variable\">CFLAGS</span><span class=\"token operator\">=</span><span class=\"token string\">\"-s USE_PTHREADS\"</span>\n<span class=\"token assign-left variable\">LDFLAGS</span><span class=\"token operator\">=</span><span class=\"token string\">\"<span class=\"token variable\">$CFLAGS</span> -s INITIAL_MEMORY=33554432\"</span> <span class=\"token comment\"># 33554432 bytes = 32 MB</span>\n<span class=\"token assign-left variable\">ARGS</span><span class=\"token operator\">=</span><span class=\"token punctuation\">(</span>\n  --target-os<span class=\"token operator\">=</span>none        <span class=\"token comment\"># use none to prevent any os specific configurations</span>\n  --arch<span class=\"token operator\">=</span>x86_32           <span class=\"token comment\"># use x86_32 to achieve minimal architectural optimization</span>\n  --enable-cross-compile  <span class=\"token comment\"># enable cross compile</span>\n  --disable-x86asm        <span class=\"token comment\"># disable x86 asm</span>\n  --disable-inline-asm    <span class=\"token comment\"># disable inline asm</span>\n  --disable-stripping     <span class=\"token comment\"># disable stripping</span>\n  --extra-cflags<span class=\"token operator\">=</span><span class=\"token string\">\"<span class=\"token variable\">$CFLAGS</span>\"</span>\n  --extra-cxxflags<span class=\"token operator\">=</span><span class=\"token string\">\"<span class=\"token variable\">$CFLAGS</span>\"</span>\n  --extra-ldflags<span class=\"token operator\">=</span><span class=\"token string\">\"<span class=\"token variable\">$LDFLAGS</span>\"</span>\n  --nm<span class=\"token operator\">=</span><span class=\"token string\">\"llvm-nm -g\"</span>\n  --ar<span class=\"token operator\">=</span>emar\n  --as<span class=\"token operator\">=</span>llvm-as\n  --ranlib<span class=\"token operator\">=</span>llvm-ranlib\n  --cc<span class=\"token operator\">=</span>emcc\n  --cxx<span class=\"token operator\">=</span>em++\n  --objcc<span class=\"token operator\">=</span>emcc\n  --dep-cc<span class=\"token operator\">=</span>emcc\n<span class=\"token punctuation\">)</span>\n\nemconfigure ./configure <span class=\"token string\">\"<span class=\"token variable\">${ARGS<span class=\"token punctuation\">[</span>@<span class=\"token punctuation\">]</span>}</span>\"</span>\n\n<span class=\"token comment\"># build ffmpeg.wasm</span>\nemmake <span class=\"token function\">make</span> -j4</code></pre></div>\n<p>Finally we managed to successfully do the <code class=\"language-text\">emmake make -j</code> part and you can see ffplay / ffplay_g, ffprobe / ffprobe_g and ffmpeg / ffmpeg_g generated in the root folder. It looks perfect, but there is a weird _g suffix makes the output files like this:</p>\n<ul>\n<li>ffmpeg</li>\n<li>ffmpeg_g</li>\n<li>ffmpeg_g.wasm</li>\n<li>ffmpeg_g.worker.js</li>\n</ul>\n<p>Both ffmpeg and ffmpeg_g here are actualy js files, the ideal naming is like below:</p>\n<ul>\n<li>ffmpeg / ffmpeg_g => ffmpeg.js</li>\n<li>ffmpeg_g.wasm => ffmpeg.wasm</li>\n<li>ffmpeg_g.worker.js => ffmpeg.worker.js</li>\n</ul>\n<p>To fix this issue, we need to build it by our own. The command to build ffmpeg can be extracted by running <code class=\"language-text\">emmake make -n</code>:</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">...\nprintf \"LD\\t%s\\n\" ffmpeg_g; emcc -Llibavcodec -Llibavdevice -Llibavfilter -Llibavformat -Llibavresample -Llibavutil -Llibpostproc -Llibswscale -Llibswresample -Wl,--as-needed -Wl,-z,noexecstack -Wl,--warn-common -Wl,-rpath-link=libpostproc:libswresample:libswscale:libavfilter:libavdevice:libavformat:libavcodec:libavutil:libavresample -Qunused-arguments   -o ffmpeg_g fftools/ffmpeg_opt.o fftools/ffmpeg_filter.o fftools/ffmpeg_hw.o fftools/cmdutils.o fftools/ffmpeg.o  -lavdevice -lavfilter -lavformat -lavcodec -lswresample -lswscale -lavutil  -lm -pthread -lm -lm -pthread -lm -lm -lm -pthread -lm\nprintf \"CP\\t%s\\n\" ffmpeg; cp -p ffmpeg_g ffmpeg\n…..</code></pre></div>\n<p>With a little clean up:</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">emcc \\\n  -I. -I./fftools \\\n  -Llibavcodec -Llibavdevice -Llibavfilter -Llibavformat -Llibavresample -Llibavutil -Llibpostproc -Llibswscale -Llibswresample \\\n  -Qunused-arguments \\\n  -o ffmpeg_g fftools/ffmpeg_opt.o fftools/ffmpeg_filter.o fftools/ffmpeg_hw.o fftools/cmdutils.o fftools/ffmpeg.o \\\n  -lavdevice -lavfilter -lavformat -lavcodec -lswresample -lswscale -lavutil -lm</code></pre></div>\n<p>As we are building our own version, let’s add <code class=\"language-text\">--disable-programs</code> and <code class=\"language-text\">--disable-doc</code> in <code class=\"language-text\">./configure</code> step to speed up the build and also add some essential flags when build ffmpeg</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token shebang important\">#!/bin/bash -x</span>\n\n<span class=\"token comment\"># verify Emscripten version</span>\nemcc -v\n\n<span class=\"token comment\"># configure FFMpeg with Emscripten</span>\n<span class=\"token assign-left variable\">CFLAGS</span><span class=\"token operator\">=</span><span class=\"token string\">\"-s USE_PTHREADS\"</span>\n<span class=\"token assign-left variable\">LDFLAGS</span><span class=\"token operator\">=</span><span class=\"token string\">\"<span class=\"token variable\">$CFLAGS</span> -s INITIAL_MEMORY=33554432\"</span> <span class=\"token comment\"># 33554432 bytes = 32 MB</span>\n<span class=\"token assign-left variable\">CONFIG_ARGS</span><span class=\"token operator\">=</span><span class=\"token punctuation\">(</span>\n  --target-os<span class=\"token operator\">=</span>none        <span class=\"token comment\"># use none to prevent any os specific configurations</span>\n  --arch<span class=\"token operator\">=</span>x86_32           <span class=\"token comment\"># use x86_32 to achieve minimal architectural optimization</span>\n  --enable-cross-compile  <span class=\"token comment\"># enable cross compile</span>\n  --disable-x86asm        <span class=\"token comment\"># disable x86 asm</span>\n  --disable-inline-asm    <span class=\"token comment\"># disable inline asm</span>\n  --disable-stripping     <span class=\"token comment\"># disable stripping</span>\n  --disable-programs      <span class=\"token comment\"># disable programs build (incl. ffplay, ffprobe &amp; ffmpeg)</span>\n  --disable-doc           <span class=\"token comment\"># disable doc</span>\n  --extra-cflags<span class=\"token operator\">=</span><span class=\"token string\">\"<span class=\"token variable\">$CFLAGS</span>\"</span>\n  --extra-cxxflags<span class=\"token operator\">=</span><span class=\"token string\">\"<span class=\"token variable\">$CFLAGS</span>\"</span>\n  --extra-ldflags<span class=\"token operator\">=</span><span class=\"token string\">\"<span class=\"token variable\">$LDFLAGS</span>\"</span>\n  --nm<span class=\"token operator\">=</span><span class=\"token string\">\"llvm-nm -g\"</span>\n  --ar<span class=\"token operator\">=</span>emar\n  --as<span class=\"token operator\">=</span>llvm-as\n  --ranlib<span class=\"token operator\">=</span>llvm-ranlib\n  --cc<span class=\"token operator\">=</span>emcc\n  --cxx<span class=\"token operator\">=</span>em++\n  --objcc<span class=\"token operator\">=</span>emcc\n  --dep-cc<span class=\"token operator\">=</span>emcc\n<span class=\"token punctuation\">)</span>\nemconfigure ./configure <span class=\"token string\">\"<span class=\"token variable\">${CONFIG_ARGS<span class=\"token punctuation\">[</span>@<span class=\"token punctuation\">]</span>}</span>\"</span>\n\n<span class=\"token comment\"># build dependencies</span>\nemmake <span class=\"token function\">make</span> -j4\n\n<span class=\"token comment\"># build ffmpeg.wasm</span>\n<span class=\"token function\">mkdir</span> -p wasm/dist\n<span class=\"token assign-left variable\">ARGS</span><span class=\"token operator\">=</span><span class=\"token punctuation\">(</span>\n  -I. -I./fftools\n  -Llibavcodec -Llibavdevice -Llibavfilter -Llibavformat -Llibavresample -Llibavutil -Llibpostproc -Llibswscale -Llibswresample\n  -Qunused-arguments\n  -o wasm/dist/ffmpeg.js fftools/ffmpeg_opt.c fftools/ffmpeg_filter.c fftools/ffmpeg_hw.c fftools/cmdutils.c fftools/ffmpeg.c\n  -lavdevice -lavfilter -lavformat -lavcodec -lswresample -lswscale -lavutil -lm\n  -s <span class=\"token assign-left variable\">USE_SDL</span><span class=\"token operator\">=</span><span class=\"token number\">2</span>                    <span class=\"token comment\"># use SDL2</span>\n  -s <span class=\"token assign-left variable\">USE_PTHREADS</span><span class=\"token operator\">=</span><span class=\"token number\">1</span>               <span class=\"token comment\"># enable pthreads support</span>\n  -s <span class=\"token assign-left variable\">INITIAL_MEMORY</span><span class=\"token operator\">=</span><span class=\"token number\">33554432</span>      <span class=\"token comment\"># 33554432 bytes = 32 MB</span>\n<span class=\"token punctuation\">)</span>\nemcc <span class=\"token string\">\"<span class=\"token variable\">${ARGS<span class=\"token punctuation\">[</span>@<span class=\"token punctuation\">]</span>}</span>\"</span></code></pre></div>\n<p>Let’s create a <a href=\"https://github.com/ffmpegwasm/FFmpeg/blob/n4.3.1-p2/wasm/basic.html\">basic.html</a> to test if ffmpeg.wasm is working:</p>\n<div class=\"gatsby-highlight\" data-language=\"html\"><pre class=\"language-html\"><code class=\"language-html\"><span class=\"token doctype\"><span class=\"token punctuation\">&lt;!</span><span class=\"token doctype-tag\">DOCTYPE</span> <span class=\"token name\">html</span><span class=\"token punctuation\">></span></span>\n<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>html</span> <span class=\"token attr-name\">lang</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>en<span class=\"token punctuation\">\"</span></span><span class=\"token punctuation\">></span></span>\n<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>head</span><span class=\"token punctuation\">></span></span>\n  <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>meta</span> <span class=\"token attr-name\">charset</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>UTF-8<span class=\"token punctuation\">\"</span></span><span class=\"token punctuation\">></span></span>\n  <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>title</span><span class=\"token punctuation\">></span></span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>title</span><span class=\"token punctuation\">></span></span>\n  <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>script</span> <span class=\"token attr-name\">src</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>./dist/ffmpeg.js<span class=\"token punctuation\">\"</span></span><span class=\"token punctuation\">></span></span><span class=\"token script\"></span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>script</span><span class=\"token punctuation\">></span></span>\n<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>head</span><span class=\"token punctuation\">></span></span>\n<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>body</span><span class=\"token punctuation\">></span></span>\n<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>body</span><span class=\"token punctuation\">></span></span>\n<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>html</span><span class=\"token punctuation\">></span></span></code></pre></div>\n<p>Run a lightweight web server (ex. <code class=\"language-text\">python3 -m http.server 3000</code>) and visit the web page (ex. <a href=\"http://localhost:3000/basic.html\">http://localhost:3000/basic.html</a>) and open the Chrome DevTools.</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 630px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/3b546c69d78cf5ea27677d9dae1afa6f/dc61a/output.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 36.708860759493675%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAHCAIAAACHqfpvAAAACXBIWXMAAAsSAAALEgHS3X78AAABDUlEQVQY03WQ2W6DMBRE+f8f60NZAmnIBhSKETRgY8BmMVuH0Ep9aKWj0Ui+y1xrkposM6vHocwMluos06G7z+MX/rDq3BbsbRB3oKQHeuFnxKrZRRMUbWZDj1tPamBKV1+V9IfmDtM3N8ldqGoDJYMR2vqD8GjmyOqmdfxQ5XbfXKv8gCV4W5d0ncg6JeucfOtuNgi86kISGjx3tY5Z/NPqqguWt/w8Sn+rGON/mcjYhWlsVhSxi1eWGjgSINU2fisiP/zR3IsgiQxenHGzXudOU9i4FsegYVHxPERzH0Lhn0Ge7GZKVPtOIqMsXK0tLVGeGuogM35V8pOgx0F6GAT2Eb9Z1McggzS2EPsLZaSDkN2YsKcAAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"output\"\n        title=\"output\"\n        src=\"/static/3b546c69d78cf5ea27677d9dae1afa6f/f058b/output.png\"\n        srcset=\"/static/3b546c69d78cf5ea27677d9dae1afa6f/c26ae/output.png 158w,\n/static/3b546c69d78cf5ea27677d9dae1afa6f/6bdcf/output.png 315w,\n/static/3b546c69d78cf5ea27677d9dae1afa6f/f058b/output.png 630w,\n/static/3b546c69d78cf5ea27677d9dae1afa6f/40601/output.png 945w,\n/static/3b546c69d78cf5ea27677d9dae1afa6f/dc61a/output.png 1147w\"\n        sizes=\"(max-width: 630px) 100vw, 630px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span></p>\n<p>It is kind of working as you can see output similar to original FFmpeg, it gives us a good starting point to polish our ffmpeg.wasm library.</p>\n<p>You can visit the repository here to see how it works in details: <a href=\"https://github.com/ffmpegwasm/FFmpeg/tree/n4.3.1-p2\">https://github.com/ffmpegwasm/FFmpeg/tree/n4.3.1-p2</a></p>\n<p>And feel free to download the build artifacts here: <a href=\"https://github.com/ffmpegwasm/FFmpeg/releases/tag/n4.3.1-p2\">https://github.com/ffmpegwasm/FFmpeg/releases/tag/n4.3.1-p2</a></p>\n<hr>\n<p>For how to polish and create a “real” ffmpeg.wasm library, please see next post in this series of stories. 😃</p>","frontmatter":{"title":"Build FFmpeg WebAssembly version (= ffmpeg.wasm): Part.2 Compile with Emscripten","date":"October 13, 2019","description":"A series of tutorials of using Emscripten to build ffmpeg"}}},"pageContext":{"slug":"/build-ffmpeg-webassembly-version-part-2-compile-with-emscripten/","previous":{"fields":{"slug":"/build-ffmpeg-webassembly-version-part-1-preparation/"},"frontmatter":{"title":"Build FFmpeg WebAssembly version (= ffmpeg.wasm): Part.1 Preparation"}},"next":{"fields":{"slug":"/build-ffmpeg-webassembly-version-part-3-v0.1/"},"frontmatter":{"title":"Build FFmpeg WebAssembly version (= ffmpeg.wasm): Part.3 ffmpeg.wasm v0.1 — Transcoding avi to mp4"}}}},"staticQueryHashes":["2841359383","916993862"]}