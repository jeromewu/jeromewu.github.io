{"componentChunkName":"component---src-templates-blog-post-js","path":"/how-to-speed-up-node-js-modules-installation/","result":{"data":{"site":{"siteMetadata":{"title":"TechBlog"}},"markdownRemark":{"id":"f0aa1ce4-0840-5dec-9f90-7359c3ee7223","excerpt":"When you use Node.js in your project, you need to take care of node_modules installation in your CI/CD pipeline. You may use , ,  and , but what is the fastestâ€¦","html":"<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 630px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/b1f666a89ec88664eeec544daa426141/6af66/npm-vs-yarn.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 62.65822784810127%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAANCAIAAAAmMtkJAAAACXBIWXMAAAsSAAALEgHS3X78AAABnElEQVQoz42Rz0sCQRTH/Zs6SMcID0JBlw568piR527dO8gu+CN1g9aD4BJBBz1Um1IgghB1CPshNWtprpGzpqvuursz2+jaD/BHPobhMbzP933fG5tpBcbk0gShQdMSw0jhMAyFSAKDQRiJDJJAoHd9PahEyPwO24g1DHI34/Gaz9c6PCw7HFIsVt/efl1f/0wkmixb29z82N39qZwEs2zr6Eja2xO9XvXuruH3S9GonE43KErc2iJys+D28XHF5XpdXQV2eyebfdvYKK+sVN3uF6fzeWFhKjyS0DS1WNQqFUjTVY8HUhQWRfXhoQ+ABgCS5Z/tTIB/VUxTx7ij621FMafHGIyJL4QQ5jiO8vv3GQaTVuSQJf/pORkmpWj4GTzPp1KpZJJTVBUP3//pbBUAKJ88inJft/zPZRsN0fv31jJzuRjKeLgC7CrNnkq0BNjp62gWbKABzBSAPZhZi+eWohfxK3BQeIrkHyP5UrHeNMfMj3dur7E5e+B85/T2pirxJVEzULevK7ox18yC1Dkr1aUecYott9Mm/wJQaby0ZjuHvAAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"NPM VS YARN\"\n        title=\"NPM VS YARN\"\n        src=\"/static/b1f666a89ec88664eeec544daa426141/f058b/npm-vs-yarn.png\"\n        srcset=\"/static/b1f666a89ec88664eeec544daa426141/c26ae/npm-vs-yarn.png 158w,\n/static/b1f666a89ec88664eeec544daa426141/6bdcf/npm-vs-yarn.png 315w,\n/static/b1f666a89ec88664eeec544daa426141/f058b/npm-vs-yarn.png 630w,\n/static/b1f666a89ec88664eeec544daa426141/6af66/npm-vs-yarn.png 640w\"\n        sizes=\"(max-width: 630px) 100vw, 630px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span></p>\n<p>When you use Node.js in your project, you need to take care of node_modules installation in your CI/CD pipeline. You may use <code class=\"language-text\">npm install</code>, <code class=\"language-text\">npm ci</code>, <code class=\"language-text\">yarn install</code> and <code class=\"language-text\">pnpm install</code>, but what is the fastest way of doing so is still a question we are looking for answers. Here in this story I would like to experiment all possibilities I know to find out the final answer.</p>\n<h2>TL;DR</h2>\n<p>If you are in a hurry, what you have to do are:</p>\n<ol>\n<li>Disable stdout output</li>\n<li>Use cached node_modules</li>\n<li>Use <code class=\"language-text\">--prefer-offline</code></li>\n<li>Use global cache (<code class=\"language-text\">yarn</code> only)</li>\n</ol>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">$ <span class=\"token function\">tar</span> zxvf node_modules.tar.gz\n$ <span class=\"token function\">npm</span> <span class=\"token function\">install</span> --prefer-offline <span class=\"token operator\">&amp;></span> /dev/null</code></pre></div>\n<p>If you prefer yarn</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">$ <span class=\"token function\">tar</span> zxvf node_modules.tar.gz\n$ <span class=\"token function\">tar</span> zxvf cache.tar.gz\n$ <span class=\"token function\">yarn</span> <span class=\"token function\">install</span> --prefer-offline --cache-folder ./cache <span class=\"token operator\">&amp;></span> /dev/null</code></pre></div>\n<p>If you prefer pnpm</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">$ <span class=\"token function\">tar</span> zxvf cache.tar.gz\n$ <span class=\"token function\">pnpm</span> config <span class=\"token builtin class-name\">set</span> store-dir <span class=\"token environment constant\">$PWD</span>/cache\n$ <span class=\"token function\">pnpm</span> <span class=\"token function\">install</span> <span class=\"token operator\">&amp;></span> /dev/null</code></pre></div>\n<blockquote>\n<p>The total speed up is around 3x comparing to pure <code class=\"language-text\">npm install</code></p>\n</blockquote>\n<h2>Existing Works</h2>\n<p>It is normal that someone already do it in the past, here are some existing works for your reference.</p>\n<ul>\n<li><a href=\"https://github.com/appleboy/npm-vs-yarn\">https://github.com/appleboy/npm-vs-yarn</a></li>\n<li><a href=\"https://winsmarts.com/npm-install-speed-up-by-3-times-almost-25ad416cf77e\">https://winsmarts.com/npm-install-speed-up-by-3-times-almost-25ad416cf77e</a></li>\n<li><a href=\"http://www.tiernok.com/posts/2019/faster-npm-installs-during-ci/\">http://www.tiernok.com/posts/2019/faster-npm-installs-during-ci/</a></li>\n</ul>\n<h2>Environment</h2>\n<h3>Packages</h3>\n<p>To prevent any cache or unexpected behavior, I run the experiment inside a docker container and every time we complete an installation, we run a new container for the next installation.</p>\n<p>The docker image I use is <code class=\"language-text\">node:12</code> and the versions of each component are:</p>\n<ul>\n<li>node: v12.16.1</li>\n<li>npm: 6.13.4</li>\n<li>yarn: 1.22.0</li>\n<li>pnpm: 4.12.1</li>\n</ul>\n<h3>Network</h3>\n<p>I experiment both remote and local registry (verdaccio) scenario to show the influence of network. In local registry, I assumed the user do something like:</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">$ <span class=\"token function\">npm</span> <span class=\"token function\">install</span> react@latest --registry http://nvy-registry:4873\n<span class=\"token comment\"># or</span>\n$ <span class=\"token function\">yarn</span> <span class=\"token function\">add</span> react@latest --registry http://nvy-registry:4873</code></pre></div>\n<p>Which makes the registry url in lock files points to the local registry directly.</p>\n<h3>Application</h3>\n<p>To mimic a real world scenario, I did experiment in an web app that is created using <code class=\"language-text\">create-react-app</code>.</p>\n<h3>Commands</h3>\n<p>There are 5 basic commands I use:</p>\n<ul>\n<li>npm install</li>\n<li>npm ci</li>\n<li>yarn install</li>\n<li>yarn install â€”frozen-lockfile</li>\n<li>pnpm install</li>\n</ul>\n<blockquote>\n<p><code class=\"language-text\">yarn install --frozen-lockfile</code> is similar to <code class=\"language-text\">npm ci</code></p>\n</blockquote>\n<p>For all of them, I add <code class=\"language-text\">&amp;&gt; /dev/null</code> to remove stdout output and the execution time is averaged from 3 times of execution. (As the execution time is pretty stable, I believe 3 times is good enough)</p>\n<p>Letâ€™s start the experiment and see where we will achieve. ðŸ˜ƒ</p>\n<h2>Parameters</h2>\n<p>There are 4 parameters we are going to tune:</p>\n<ol>\n<li>local registry</li>\n</ol>\n<p>With local registry, you can prevent stale when the network bandwidth is not enough. It is a good way to speed up but may be painful when someone clone your repository but unable to access the local registry you used. 2. cached node_modules</p>\n<p>A common technique to speed up the installation, by zipping <code class=\"language-text\">node_modules</code> folder and unzipping before installation to eliminate the need of downloading modules again from network. 3. global cache</p>\n<p>There is a global cache folder in <code class=\"language-text\">~/.npm</code> for npm and <code class=\"language-text\">~/.yarn</code> for yarn, by adding global cache in advance, I would like to know if it is possible to speed up. 4. <code class=\"language-text\">--prefer-offline</code></p>\n<p>Details: <a href=\"https://docs.npmjs.com/misc/config#prefer-offline\">https://docs.npmjs.com/misc/config#prefer-offline</a></p>\n<blockquote>\n<p>If true, staleness checks for cached data will be bypassed, but missing data will be requested from the server. To force full offline mode, use <code class=\"language-text\">--offline</code>.</p>\n</blockquote>\n<p>With this option, we can prevent npm or yarn to check remote data and use local cache directly.</p>\n<h2>Experiment</h2>\n<p>Below are the result of all configurations:</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 630px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/f4a3672cf81785fc1781387354b2ce1a/5a6dd/statistics.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 143.67088607594937%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAdCAIAAAAl5NuSAAAACXBIWXMAAAsSAAALEgHS3X78AAAD20lEQVQ4y4VVS28bVRTOj2CDECx4bBCCFV0UEN2wqpAQvwDURVf8gQoVIlpUUrpgAX2AWqpGVqHNy484mCYNaV5+Tsb2+O14bGc8Hsfztj3ve7jxOI4TnHA0ujr3zv3ufOd859yZAADLsmzbtvpm9s31HceBviGETjiuTeC5JEmqquKx0+mIgqDIA9N0DY4ZOj6Fif55B56gOqKsGEK7125b+n5X4uSO2lL2FUmWFVmSFVNqqhKvKOox8NAwS+fw9AFDZCHbtE3DsUxkG7ZljsYyAGuaJoh8KV8Jetb+frIZ+mN9OcysZrvPcg7THeE9EvMRuMk2YolUdG02cOPVwNSbgR9eX5r+ODR/kSUeITqGKmGoRoAOo057GPwRGCdMECWRb0mNtMrlVS4nVeJyMWyUtqGyhXY38Qi7G0hpjQHjSDA2nyn4Hv4V9CwvTodCkXqo0FtnHH0ky6PpPgI3GnuRGBlff7py86WVW6+s/Pjy6u/vrj/90CDuQG4JUQGggpDyovrOGLCu671eF8sgCJIiq7KsCiwnVmsKnZd3qS5NQTMLbNoR906CMWdcIbwgFKjM/M/3/Pfu+365G5gPhDL0P7T1vApkG5xDLU+CDcMoFHLReDIZXojcfi1y963InTciD99JLFwwqQdQ9qHMPOYMxAzi8mNoD9TWbYazWwJwPLCs3qypTLnOlCs9lgahBnwFdYWTYNwVqqI0mk0qEZu58fXcrcm5qave2ekgEd2omJE9EE0Ep9HG2SqXSwSZzSSCxPR7hOcc4XmfeHI+6fvEIn+DzByQM7AzA+Qsij+GdmWAdZyJUQG7GioxUGtBlQOaBZoBVZCdDo8f6An4Oagw2zgZs6HrxfJufOO59/vLvqmv/NcvBx9de0YsCp3eAdujfh5XJKLAU5liIb1KBT7NLH6WWrmUKN8n638apuRqeVZjuFNJNnNlKNDQ4hBODvpPM40BY515vl0sV8itZe/kxYVrn5emf7UyqQM4cnvg9C/j66rV4oqlKl3czq9+WVy9ZHAbeBdyrGEDnUXbXVQVmyScdApkxgITjdA+/TLAOjPMHpnOxtb83m/OLUx+tHnzA8r/RY78trOfAE1xcGFpEmgi0jvjG6NeZ5lashC9Uk5MZiLXyReT5MoVOfIAkl5EzuMR1wmqxk6lLfJaYsPY2TbFkgQMh+TuYNcZMePbj2uyZCobf+Hzf/d2aOrC/pJH31o3itlBrs/W2TB0rtVuMoVC9Kda4rbNJkYT9T/ZHpJ3FcUvTE1zwXbfDr9huHjMBQs8MXoSXsL/LDxgdwhw+ub6w0W8Gfv/Akz7O2dJU/F3AAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"Statistics\"\n        title=\"Statistics\"\n        src=\"/static/f4a3672cf81785fc1781387354b2ce1a/f058b/statistics.png\"\n        srcset=\"/static/f4a3672cf81785fc1781387354b2ce1a/c26ae/statistics.png 158w,\n/static/f4a3672cf81785fc1781387354b2ce1a/6bdcf/statistics.png 315w,\n/static/f4a3672cf81785fc1781387354b2ce1a/f058b/statistics.png 630w,\n/static/f4a3672cf81785fc1781387354b2ce1a/5a6dd/statistics.png 802w\"\n        sizes=\"(max-width: 630px) 100vw, 630px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span></p>\n<blockquote>\n<p>The number is the amount of seconds to complete modules installation</p>\n</blockquote>\n<h2>Observations</h2>\n<ul>\n<li>Always remember to disable the output of installation with <code class=\"language-text\">&amp;&gt; /dev/null</code> as stdout is pretty time-consuming</li>\n<li>Although local registry can guarantee the stability of downloading modules, it is not recommended to modify lock file to gain this benefit as the side effect is huge.</li>\n<li>The speed of <code class=\"language-text\">npm ci</code> is stable across different configurations, but <code class=\"language-text\">npm install</code> can be faster with <code class=\"language-text\">--prefer-offline</code>.</li>\n<li>The speed of <code class=\"language-text\">yarn install</code> and <code class=\"language-text\">yarn install --frozen-lockfile</code> are NOT different at all.\nGlobal cache is more useful for <code class=\"language-text\">yarn</code></li>\n<li>The efficient of <code class=\"language-text\">pnpm</code> highly relies on the global cache, without cache, its speed is slower than others due to cache pre-processing overhead</li>\n</ul>\n<hr>\n<p>For the source code of this experiment can be found in this repository: <a href=\"https://github.com/jeromewu/npm-vs-yarn-in-cicd\">https://github.com/jeromewu/npm-vs-yarn-in-cicd</a></p>\n<p>Hope you find it helpful and if you have any ideas to experiment to speed up even further, please feel free to leave a response or create an issue inside the repository. ðŸ˜„</p>","frontmatter":{"title":"How to speed up Node.js modules installation in CI/CD pipeline as of 2020","date":"March 28, 2020","description":"The optimal way of installing node_modules in CI/CD pipeline"}}},"pageContext":{"slug":"/how-to-speed-up-node-js-modules-installation/","previous":{"fields":{"slug":"/i-wrote-a-chrome-extension-here-is-what-i-learned/"},"frontmatter":{"title":"I wrote a Chrome Extension (Gitpod Window). Here is what I learned"}},"next":{"fields":{"slug":"/how-to-fix-hidpi-issues-in-gulliam-os-3.1/"},"frontmatter":{"title":"How to fix (80%) HiDPI issues in Gulliam OS 3.1"}}}},"staticQueryHashes":["2841359383","916993862"]}