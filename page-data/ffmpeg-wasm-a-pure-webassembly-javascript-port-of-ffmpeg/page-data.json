{"componentChunkName":"component---src-templates-blog-post-js","path":"/ffmpeg-wasm-a-pure-webassembly-javascript-port-of-ffmpeg/","result":{"data":{"site":{"siteMetadata":{"title":"TechBlog"}},"markdownRemark":{"id":"17ed182b-2490-5e17-8126-2c2e89aec275","excerpt":"Official Website: https://ffmpegwasm.github.io/ FFmpeg is a famous framework/tool when it comes to video/audio processing, now with ffmpeg.wasm you can use…","html":"<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 256px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/107d248b86a21db313af2f7df1c1ded1/6f3f2/ffmpeg-wasm-logo.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 100%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAUCAYAAACNiR0NAAAACXBIWXMAAJ17AACdewE8n3fEAAACtUlEQVQ4y4VVTUwTQRTetjc1ROPfRU6N8ejdiwc9lh3aUkRjAgndwrZrW8FqQUQl1L/Ei8bEm3ej4ejNhJvRKHjybLSJgYRZ4j8Uhu/Nvt1sl5Ju8uXNzrz59pv33rw18qY06CELJCzhJsI2up43XazJqE/M9zHaBns8tAGbY1182gewhwAHG6dgb0DFDGwB2B/alIPCm3khaxjX4TsNOwEc8z+sj8Ev5euXlXJyShWzLWVn/qvqBaUwP8Trd2m+OqRUedDzGU//VZOXtM8s+VjEFTp/ErgHLGKhZWc2yPFdPrUWz0NJKbutxtJ/MOe+wPxrYNN7l1+Bk4FCHvgqTwBfruT0Vz/orwr3GpEVs1vKMt0S+711BsjHbQJJnosbYVbYU8BKxTvmez0n3JpPho3OiFiJY22JQ9EkAX58C2LdiKqbYrKPAdmA8smKw+YqkS1XBrXPN+AwkOIjnw9UUi3x0WoUcGx+jLHtMJmllWmyJSYjZUeQ6VSh/5efuEfMkQgrrJd0XOQPS6wrGlPMRtqVfdfKhDTH0/8U+dmZTVi30UlhnTKL+tsuZZWnzNyljMhSRMYZXtXJEbLRSeEs1Rd/scTHjCrrIyLyw3gO4bk9eVGR/51AoZ9u2LN0XKDYURkSMNb/W3FJPfX2uG+u6rjLB4FCeuz0z+BOjppr+0iZl6CAzIySYfNC2fvgBnAmWoueSiEPAp8dvdFdHu2TPfqYPpmQT7ikFugdN6qJWJ8Ol1+4sI8CnyjgsC0QvtRXUcgWK3vGfq/oHiN5W/BZxDs1imSn5lCli06ZpttB9TWBgDPZc/Y5R3OUOKpRWpse3rs5HAdmEJv7sA0szuE41CzsUPs6AFTg8xB2HnYe9hbQG20ORrcncO62HmqwMQSb2nqc2rzf4q1dvwE3/JuI8+8g+AXsAHjhl9WKZGm7AAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"ffmpeg wasm logo\"\n        title=\"ffmpeg wasm logo\"\n        src=\"/static/107d248b86a21db313af2f7df1c1ded1/6f3f2/ffmpeg-wasm-logo.png\"\n        srcset=\"/static/107d248b86a21db313af2f7df1c1ded1/c26ae/ffmpeg-wasm-logo.png 158w,\n/static/107d248b86a21db313af2f7df1c1ded1/6f3f2/ffmpeg-wasm-logo.png 256w\"\n        sizes=\"(max-width: 256px) 100vw, 256px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span></p>\n<p>Official Website: <a href=\"https://ffmpegwasm.github.io/\">https://ffmpegwasm.github.io/</a></p>\n<p>FFmpeg is a famous framework/tool when it comes to video/audio processing, now with ffmpeg.wasm you can use FFmpeg right inside your browser without installation or upload your file to the server. Although ffmpeg.wasm is not as fast as FFmpeg, but it might come in handy for certain use cases.</p>\n<p>In this post, I would like to share how to install and use ffmpeg.wasm and also technical details behind to support your usage.</p>\n<h1>Install ffmpeg.wasm</h1>\n<p>To install and use ffmpeg.wasm, you only need to use npm/yarn:</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">$ <span class=\"token function\">npm</span> <span class=\"token function\">install</span> @ffmpeg/ffmpeg\n<span class=\"token comment\"># or</span>\n$ <span class=\"token function\">yarn</span> <span class=\"token function\">add</span> @ffmpeg/ffmpeg</code></pre></div>\n<p>To use ffmpeg.wasm in node environment, you also need to install <code class=\"language-text\">@ffmpeg/core</code> .</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">$ <span class=\"token function\">npm</span> <span class=\"token function\">install</span> @ffmpeg/core\n<span class=\"token comment\"># or</span>\n$ <span class=\"token function\">yarn</span> <span class=\"token function\">add</span> @ffmpeg/core</code></pre></div>\n<p>Or you can use a CDN</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token operator\">&lt;</span>script <span class=\"token assign-left variable\">src</span><span class=\"token operator\">=</span><span class=\"token string\">'https://unpkg.com/@ffmpeg/ffmpeg@0.9.3/dist/ffmpeg.min.js'</span><span class=\"token operator\">></span><span class=\"token operator\">&lt;</span>/script<span class=\"token operator\">></span></code></pre></div>\n<h1>Use ffmpeg.wasm</h1>\n<p>To use ffmpeg.wasm, only few lines of code are required:</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token keyword\">const</span> fs <span class=\"token operator\">=</span> <span class=\"token function\">require</span><span class=\"token punctuation\">(</span><span class=\"token string\">'fs'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">const</span> <span class=\"token punctuation\">{</span> createFFmpeg<span class=\"token punctuation\">,</span> fetchFile <span class=\"token punctuation\">}</span> <span class=\"token operator\">=</span> <span class=\"token function\">require</span><span class=\"token punctuation\">(</span><span class=\"token string\">'@ffmpeg/ffmpeg'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">const</span> ffmpeg <span class=\"token operator\">=</span> <span class=\"token function\">createFFmpeg</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span> log<span class=\"token operator\">:</span> <span class=\"token boolean\">true</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">(</span><span class=\"token keyword\">async</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">await</span> ffmpeg<span class=\"token punctuation\">.</span><span class=\"token function\">load</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  ffmpeg<span class=\"token punctuation\">.</span><span class=\"token constant\">FS</span><span class=\"token punctuation\">(</span><span class=\"token string\">'writeFile'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'test.avi'</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">await</span> <span class=\"token function\">fetchFile</span><span class=\"token punctuation\">(</span><span class=\"token string\">'./test.avi'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">await</span> ffmpeg<span class=\"token punctuation\">.</span><span class=\"token function\">run</span><span class=\"token punctuation\">(</span><span class=\"token string\">'-i'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'test.avi'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'test.mp4'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  fs<span class=\"token punctuation\">.</span><span class=\"token function\">writeFileSync</span><span class=\"token punctuation\">(</span><span class=\"token string\">'./test.mp4'</span><span class=\"token punctuation\">,</span> ffmpeg<span class=\"token punctuation\">.</span><span class=\"token constant\">FS</span><span class=\"token punctuation\">(</span><span class=\"token string\">'readFile'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'test.mp4'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  process<span class=\"token punctuation\">.</span><span class=\"token function\">exit</span><span class=\"token punctuation\">(</span><span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<blockquote>\n<p>Don’t forget to add <code class=\"language-text\">--experimental-wasm-threads</code> and <code class=\"language-text\">--experimental-wasm-bulk-memory</code> when executing the script in node.</p>\n</blockquote>\n<p>Also you can try the live demo session in the official website: <a href=\"https://ffmpegwasm.github.io/#demo\">https://ffmpegwasm.github.io/#demo</a></p>\n<p><img src=\"/815f07c1293ede899b156c597e324ed6/transcode.gif\"></p>\n<h1>Behind the scene</h1>\n<p>To fully utilize/understand the power of ffmpeg.wasm (also for most WebAssembly libraries), few technical details you might want to know:</p>\n<h2>Inside ffmpeg.load()</h2>\n<p><code class=\"language-text\">ffmpeg.load()</code> is a required API to call before you call others. What happened inside this API is:</p>\n<ul>\n<li>Download ffmpeg-core.js from remote server (which is around 25MB)</li>\n<li>Instantiate ffmpeg.wasm wasm code</li>\n<li>-\nDepending on your network speed and host machine hardware, this operation can take up to minutes to complete.</li>\n</ul>\n<h2>File System (FS)</h2>\n<p>When you check the API of ffmpeg.wasm, you may find an API called ffmpeg.FS() to handle File System operations. (In ffmpeg.wasm we use MEMFS / Memory File System) You can imagine this FS just like a hard disk where you can put the input file and pull the output file from ffmpeg.wasm command. It is essential as we want to keep minimal changes to FFmpeg source code and reserve its maxium similarity to original command line interface. Some command operations you might use:</p>\n<ol>\n<li><code class=\"language-text\">ffmpeg.FS(&#39;writeFile&#39;, &#39;filename&#39;, data)</code> : write file to MEMFS as input of ffmpeg.wasm</li>\n<li><code class=\"language-text\">ffmpeg.FS(&#39;readFile&#39;, &#39;filename&#39;)</code> : read file from MEMFS as output of ffmpeg.wasm</li>\n<li><code class=\"language-text\">ffmpeg.FS(&#39;unlink&#39;, &#39;filename&#39;)</code> : delete a file in MEMFS</li>\n<li><code class=\"language-text\">ffmpeg.FS(&#39;readdir&#39;, &#39;/&#39;)</code> : list files inside specific path</li>\n</ol>\n<p>For full list of APIs, you can check: <a href=\"https://emscripten.org/docs/api_reference/Filesystem-API.html\">https://emscripten.org/docs/api_reference/Filesystem-API.html</a></p>\n<h2>SharedArrayBuffer</h2>\n<p>SharedArrayBuffer is a pretty new data type in JavaScript, right now most of the browsers still lack of fully support due to security issues. But in ffmpeg.wasm, to enable pthread / mutli-threading support to speed up, it is a required data type to use. </p>\n<ul>\n<li>SharedArrayBuffer introduction: <a href=\"https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/SharedArrayBuffer\">https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/SharedArrayBuffer</a></li>\n<li>Can I use SharedArrayBuffer?: <a href=\"https://caniuse.com/sharedarraybuffer\">https://caniuse.com/sharedarraybuffer</a></li>\n</ul>\n<h2>Web Workers</h2>\n<p>When you run ffmpeg.run() , you might find tons of web workers spawned. It is a normal situation as web workers are simulating threads in FFmpeg and it is good as we don’t want ffmpeg.wasm to block our main thread.</p>\n<h2>Leverage CPU capabilities</h2>\n<p>For most of libraries work with ffmpeg (ex. x264), they use assembly language like x86 to speed up the process. But sadly, WebAssembly cannot directly use these x86 assembly code as it is not compatible or certain instructions are not supported. Thus it takes time to port x86 assembly to SIMD assembly to make it work.</p>\n<hr>\n<p>It is still a long way to go as ffmpeg.wasm is still in an early stage (right now it is only v0.9), although it is still very slow comparing to original version, but with the growth and evolution of WebAssembly, I believe it will become more and more useful. 😃</p>\n<p>Feel free to try and comments, issues or/and PRs are highly welcome!</p>\n<p>Github: <a href=\"https://github.com/ffmpegwasm/ffmpeg.wasm\">https://github.com/ffmpegwasm/ffmpeg.wasm</a></p>","frontmatter":{"title":"FFmpeg.wasm, a pure WebAssembly / JavaScript port of FFmpeg","date":"November 04, 2020","description":"Introduction to ffmpeg.wasm and technical details behind"}}},"pageContext":{"slug":"/ffmpeg-wasm-a-pure-webassembly-javascript-port-of-ffmpeg/","previous":{"fields":{"slug":"/how-to-fix-hidpi-issues-in-gulliam-os-3.1/"},"frontmatter":{"title":"How to fix (80%) HiDPI issues in Gulliam OS 3.1"}},"next":{"fields":{"slug":"/generics-in-golang-1.18-no-need-to-write-max-min-anymore-maybe/"},"frontmatter":{"title":"Generics in Golang 1.18, no need to write max / min anymore (maybe)"}}}},"staticQueryHashes":["2841359383","916993862"]}